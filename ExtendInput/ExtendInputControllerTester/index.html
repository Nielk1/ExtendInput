<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <style>
        svg .active {
            fill: #333;
        }

        svg .disable {
            fill: red;
        }

        svg .active-o {
            stroke: #333;
        }

        svg .disable-o {
            stroke: red;
        }

        .controller_icon,
        .connection_icon {
            width: auto;
            height: 32px;
            padding-right: 5px;
        }

        #controllers {
            float: left;
            width: 400px;
            height: 100vh;
            overflow-y: scroll;
            position: fixed;
        }
        #state_data {
            padding-left: 400px;
            margin-left: 5px;
            margin-right: 5px;
        }
        .activate_controller::after {
            content: "Activate";
        }
        .controller-active .activate_controller::after {
            content: "Deactivate";
        }
    </style>

    <title>Hello, world!</title>
</head>
<body>
    <div class="fluid-container">
        <div class="" id="controllers"></div>
        <div class="row" id="state_data"></div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>

    <script>
        /*const socket = new WebSocket("ws://" + location.host + "/terminal");

        socket.addEventListener('open', function (event) {
            socket.send('Hello Server!');
        });

        // Listen for messages
        socket.addEventListener('message', function (event) {
            console.log('Message from server ', event.data);
        });*/

        /*exampleSocket.onopen = function (event) {
            exampleSocket.send("Here's some text that the server is urgently awaiting!");
            //exampleSocket.send(JSON.stringify({ test: true }));
        };*/

        var $controllers = null;

        var ControllerActive = false;
        var ControllerActiveSubtype = null;
        var ControllerPollAjax = null;

        $(document).ready(function () {
            var $controllers = $('#controllers');
            var $state_data = $('#state_data');

            $controllers.on('click', '.activate_controller', function (evt) {
                evt.preventDefault();
                $state_data.empty();
                //$('#controller_state').remove();
                if (ControllerActive) {
                    if (ControllerPollAjax != null) ControllerPollAjax.abort();
                    ControllerActive = false;
                    $controllers.find('.card.border-primary').removeClass('border-primary');
                    $('body').removeClass('controller-active');
                } else {
                    $(evt.target).parent().addClass('border-primary');
                    //$(evt.target).parent().parent().after('<div id="controller_state" class="col-sm-6 col-lg-4 pb-4"/><div class="card"><div class="card-body">TEST</div></div></div>');

                    $.post("/activate_controller", $(evt.target).data('id'), function (data) {
                        if (data) {
                            ControllerActive = true;
                            $('body').addClass('controller-active');
                            PollControllerFunc();
                        } else {
                            //$('#controller_state').remove();
                        }
                    });
                }
                return true;
            });

            $controllers.on('click', '.alternate_controller', function (evt) {
                evt.preventDefault();
                var controllerID = $(evt.currentTarget).parents('.controller').attr('id').split('_')[1];
                var alternateID = $(evt.target).data('id');
                $.post("/alternate_controller", { controller: controllerID, alternate: alternateID }, function (data) {
                    /*if (data) {
                        PollControllerFunc();
                    }*/
                });
                return true;
            });

            function DrawButtonSvg(name, x, y) {
                return '<ellipse class="' + name + '_click" ry="29" rx="29" cy="' + y + '" cx="' + x + '" stroke="#ccc" fill="none" stroke-width="3" />' +
                    '<ellipse class="" ry="25" rx="25" cy="' + y + '" cx="' + x + '" stroke="#000" fill="#fff" />' +
                    '<ellipse class="' + name + '_data" ry="0" rx="0" cy="' + y + '" cx="' + x + '" stroke="#000" fill="#333" />';
            }

            function PollControllerFunc() {
                if (ControllerPollAjax != null) ControllerPollAjax.abort();
                if (ControllerActive) {
                    ControllerPollAjax = $.get("/poll_controller", function (data) {
                        var knownChildren = {};
                        $state_data.children().each((i, elem) => knownChildren[elem.id] = true);
                        var NewSubtype = (ControllerActiveSubtype != data.subtype);
                        ControllerActiveSubtype = data.subtype;
                        for (const control_id in data.controls) {
                            var existing = $state_data.children('#state_' + control_id);
                            var control = data.controls[control_id];

                            if (existing.length == 0) {
                                //var wrapper = $('<div class="col-sm-6 col-md-4 col-lg-3 pb-4"/>');
                                var wrapper = $('<div class="col-sm-12 col-md-12 col-lg-6 col-xl-4 pb-4"/>');
                                wrapper.attr('id', 'state_' + control_id);
                                wrapper.append('<div class="card"><div class="pb-3"><h5 class="card-title text-center">' + control_id + '</h5><div class="control_type card-title text-center small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + control.Type + '</div><div class="card-text control-value" style="white-space:pre;"></div></div></div>');
                            } else {
                                wrapper = existing;
                                var controlType = wrapper.find('.control_type');
                                if (controlType.text() != control.Type)
                                    controlType.text(control.Type);
                                delete knownChildren['state_' + control_id];
                            }

                            switch (control.Type) {
                                case 'ExtendInput.Controls.ControlButtonQuad':
                                    {
                                        var renderElement = wrapper.find('.control-value');
                                        renderElement.addClass('text-center');
                                        if (NewSubtype || renderElement.children('svg').length == 0) {
                                            renderElement.empty().append(
                                                '<svg id="control_render_' + control_id + '" width="182" height="182" xmlns="http://www.w3.org/2000/svg">' +
                                                '<g>' +
                                                '<ellipse class="btn_n" ry="30" rx="30" cy="151" cx="091" stroke="#000" fill="#fff" />' +
                                                //DrawButtonSvg("btn_n", 091, 151) +
                                                '<ellipse class="btn_e" ry="30" rx="30" cy="091" cx="151" stroke="#000" fill="#fff" />' +
                                                //DrawButtonSvg("btn_n", 151, 091) +
                                                '<ellipse class="btn_s" ry="30" rx="30" cy="031" cx="091" stroke="#000" fill="#fff" />' +
                                                //DrawButtonSvg("btn_n", 091, 031) +
                                                '<ellipse class="btn_w" ry="30" rx="30" cy="091" cx="031" stroke="#000" fill="#fff" />' +
                                                //DrawButtonSvg("btn_n", 031, 091) +
                                                '</g>' +
                                                '</svg>');
                                        }
                                        var ctrl = $('#control_render_' + control_id);
                                        if (control.Data.ButtonS) ctrl.find('.btn_n').addClass('active'); else ctrl.find('.btn_n').removeClass('active');
                                        if (control.Data.ButtonE) ctrl.find('.btn_e').addClass('active'); else ctrl.find('.btn_e').removeClass('active');
                                        if (control.Data.ButtonN) ctrl.find('.btn_s').addClass('active'); else ctrl.find('.btn_s').removeClass('active');
                                        if (control.Data.ButtonW) ctrl.find('.btn_w').addClass('active'); else ctrl.find('.btn_w').removeClass('active');
                                    }
                                    break;
                                case 'ExtendInput.Controls.ControlDPad':
                                    {
                                        var renderElement = wrapper.find('.control-value');
                                        renderElement.addClass('text-center');
                                        if (NewSubtype || renderElement.children('svg').length == 0) {
                                            renderElement.empty().append(
                                                '<svg id="control_render_' + control_id + '" width="182" height="182" xmlns="http://www.w3.org/2000/svg">' +
                                                '<g>' +
                                                '<path class="btn_n" d="M 091,031 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(180 091 031) translate(-30,-30)"></path>' +
                                                '<path class="btn_e" d="M 151,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(-90 151 091) translate(-30,-30)"></path>' +
                                                '<path class="btn_s" d="M 091,151 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(0 091 151) translate(-30,-30)"></path>' +
                                                '<path class="btn_w" d="M 031,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(90 031 091) translate(-30,-30)"></path>' +
                                                '</g>' +
                                                '</svg>');
                                        }
                                        var ctrl = $('#control_render_' + control_id);
                                        switch (control.Data.Direction) {
                                            case 0: ctrl.find('.btn_n,.btn_e,.btn_s,.btn_w').removeClass('active'); break;
                                            case 1: ctrl.find('       .btn_e,.btn_s,.btn_w').removeClass('active'); ctrl.find('.btn_n                     ').addClass('active'); break;
                                            case 2: ctrl.find('              .btn_s,.btn_w').removeClass('active'); ctrl.find('.btn_n,.btn_e              ').addClass('active'); break;
                                            case 3: ctrl.find('.btn_n,       .btn_s,.btn_w').removeClass('active'); ctrl.find('       .btn_e              ').addClass('active'); break;
                                            case 4: ctrl.find('.btn_n,              .btn_w').removeClass('active'); ctrl.find('       .btn_e,.btn_s       ').addClass('active'); break;
                                            case 5: ctrl.find('.btn_n,.btn_e,       .btn_w').removeClass('active'); ctrl.find('              .btn_s       ').addClass('active'); break;
                                            case 6: ctrl.find('.btn_n,.btn_e              ').removeClass('active'); ctrl.find('              .btn_s,.btn_w').addClass('active'); break;
                                            case 7: ctrl.find('.btn_n,.btn_e,.btn_s       ').removeClass('active'); ctrl.find('                     .btn_w').addClass('active'); break;
                                            case 8: ctrl.find('       .btn_e,.btn_s       ').removeClass('active'); ctrl.find('.btn_n,              .btn_w').addClass('active'); break;
                                        }
                                    }
                                    break;
                                case 'ExtendInput.Controls.ControlButtonPair':
                                    {
                                        var renderElement = wrapper.find('.control-value');
                                        renderElement.addClass('text-center');
                                        if (NewSubtype || renderElement.children('svg').length == 0) {
                                            renderElement.empty().append(
                                                '<svg id="control_render_' + control_id + '" width="182" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                                '<g>' +
                                                '<ellipse class="btn_r" ry="30" rx="30" cy="31" cx="151" stroke="#000" fill="#fff" />' +
                                                '<ellipse class="btn_l" ry="30" rx="30" cy="31" cx="031" stroke="#000" fill="#fff" />' +
                                                '</g>' +
                                                '</svg>');
                                        }
                                        var ctrl = $('#control_render_' + control_id);
                                        if (control.Data.Left.Button0) ctrl.find('.btn_l').addClass('active'); else ctrl.find('.btn_l').removeClass('active');
                                        if (control.Data.Right.Button0) ctrl.find('.btn_r').addClass('active'); else ctrl.find('.btn_r').removeClass('active');
                                    }
                                    break;
                                case 'ExtendInput.Controls.ControlButton':
                                    {
                                        var renderElement = wrapper.find('.control-value');
                                        renderElement.addClass('text-center');
                                        if (NewSubtype || renderElement.children('svg').length == 0) {
                                            renderElement.empty().append(
                                                '<svg id="control_render_' + control_id + '" width="62" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                                '<g>' +
                                                '<ellipse class="btn_x" ry="30" rx="30" cy="31" cx="031" stroke="#000" fill="#fff" />' +
                                                '</g>' +
                                                '</svg>');
                                        }
                                        var ctrl = $('#control_render_' + control_id);
                                        if (control.Data.Button0) ctrl.find('.btn_x').addClass('active'); else ctrl.find('.btn_x').removeClass('active');
                                    }
                                    break;
                                case 'ExtendInput.Controls.ControlTriggerPair':
                                    {
                                        var renderElement = wrapper.find('.control-value');
                                        renderElement.addClass('text-center');
                                        if (NewSubtype || renderElement.children('svg').length == 0) {
                                            renderElement.empty().append(
                                                '<svg id="control_render_' + control_id + '" width="182" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                                '<g>' +

                                                //'<ellipse class="btn_r_click" ry="29" rx="29" cy="31" cx="151" stroke="#ccc" fill="none" stroke-width="3" />' +
                                                //'<ellipse class="" ry="25" rx="25" cy="31" cx="151" stroke="#000" fill="#fff" />' +
                                                //'<ellipse class="btn_r_data" ry="0" rx="0" cy="31" cx="151" stroke="#000" fill="#333" />' +
                                                DrawButtonSvg("btn_r", 151, 31) +

                                                //'<ellipse class="btn_l_click" ry="29" rx="29" cy="31" cx="031" stroke="#ccc" fill="none" stroke-width="3" />' +
                                                //'<ellipse class="" ry="25" rx="25" cy="31" cx="031" stroke="#000" fill="#fff" />' +
                                                //'<ellipse class="btn_l_data" ry="0" rx="0" cy="31" cx="031" stroke="#000" fill="#333" />' +
                                                DrawButtonSvg("btn_l", 31, 31) +

                                                '</g>' +
                                                '</svg>');
                                        }
                                        var ctrl = $('#control_render_' + control_id);
                                        ctrl.find('.btn_l_data').attr('rx', control.Data.Left.Analog * 25).attr('ry', control.Data.Left.Analog * 25);
                                        ctrl.find('.btn_r_data').attr('rx', control.Data.Right.Analog * 25).attr('ry', control.Data.Right.Analog * 25);
                                        if (control.Data.Left.HasStage2) if (control.Data.Left.Stage2) ctrl.find('.btn_l_click').addClass('active-o'); else ctrl.find('.btn_l_click').removeClass('active-o', 'disable-o'); else ctrl.find('.btn_l_click').addClass('disable-o');
                                        if (control.Data.Right.HasStage2) if (control.Data.Right.Stage2) ctrl.find('.btn_r_click').addClass('active-o'); else ctrl.find('.btn_r_click').removeClass('active-o', 'disable-o'); else ctrl.find('.btn_r_click').addClass('disable-o');
                                    }
                                    break;
                                case 'ExtendInput.Controls.ControlStick':
                                    {
                                        var renderElement = wrapper.find('.control-value');
                                        renderElement.addClass('text-center');
                                        if (NewSubtype || renderElement.children('svg').length == 0) {
                                            renderElement.empty().append(
                                                '<svg id="control_render_' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                                '<g>' +
                                                '<path class="stick_click" d="M 2,2 m 0,136 136,0 0,-136 -136,0 z" stroke="#999" fill="none" stroke-width="3"></path>' +
                                                '<path class="" d="M 6,6 m 0,128 128,0 0,-128 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                                '<ellipse class="" ry="64" rx="64" cy="70" cx="70" stroke="#000" fill="#fff" />' +
                                                '<ellipse class="stick_float" ry="2" rx="2" cy="70" cx="70" fill="#000" />' +
                                                '</g>' +
                                                '</svg>');
                                        }
                                        var ctrl = $('#control_render_' + control_id);
                                        var stickFloat = ctrl.find('.stick_float');
                                        stickFloat.attr('cx', 70 + control.Data.X * 63);
                                        stickFloat.attr('cy', 70 + control.Data.Y * 63);
                                        if (control.Data.HasClick) if (control.Data.Click) ctrl.find('.stick_click').addClass('active-o'); else ctrl.find('.stick_click').removeClass('active-o', 'disable-o'); else ctrl.find('.stick_click').addClass('disable-o');
                                    }
                                    break;
                                case 'ExtendInput.Controls.ControlTouch':
                                    {
                                        var renderElement = wrapper.find('.control-value');
                                        renderElement.addClass('text-center');
                                        var ratioW = 1;
                                        var ratioH = 1;
                                        if (control.Data.PhysicalWidth > control.Data.PhysicalHeight) {
                                            ratioH = control.Data.PhysicalHeight / control.Data.PhysicalWidth;
                                        } else {
                                            ratioW = control.Data.PhysicalWidth / control.Data.PhysicalHeight;
                                        }
                                        if (!isFinite(ratioW) || !isFinite(ratioH)) {
                                            ratioW = 1;
                                            ratioH = 1;
                                        }
                                        if (NewSubtype || renderElement.children('svg').length == 0) {
                                            var domString =
                                                '<svg id="control_render_' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                                '<g transform="translate(' + (((1 - ratioW) / 2) * 130) + ',' + (((1 - ratioH) / 2) * 130) + ')">' +
                                                '<path class="pad_click" d="M 2,2 m 0,' + (128 * ratioH + 8) + ' ' + (128 * ratioW + 8) + ',0 0,-' + (128 * ratioH + 8) + ' -' + (128 * ratioW + 8) + ',0 z" stroke="#999" fill="none" stroke-width="3"></path>' +
                                                '<path class="" d="M 6,6 m 0,' + (128 * ratioH) + ' ' + (128 * ratioW) + ',0 0,-' + (128 * ratioH) + ' -' + (128 * ratioW) + ',0 z" stroke="#000" fill="#fff"></path>';
                                            //'<ellipse class="" ry="64" rx="64" cy="70" cx="70" stroke="#000" fill="#fff" />' +
                                            for (var i = 0; i < control.Data.Touch.length; i++) {
                                                domString +=
                                                    '<g cy="70" cx="70" class="pad_float_' + i + '" style="display: none;">' +
                                                    '<ellipse ry="2" rx="2" cy="0" cx="0" fill="#000" />' +
                                                    '<text class="pad_float_text" style="font-size: small;" x="-4" y="4" transform="translate(5,-5)">' + i + '</text>' +
                                                    '</g>';
                                            }
                                            domString +=
                                                '</g>' +
                                                '</svg>';
                                            renderElement.empty().append(domString);
                                        }
                                        var ctrl = $('#control_render_' + control_id);
                                        for (var i = 0; i < control.Data.Touch.length; i++) {
                                            var stickFloat = ctrl.find('.pad_float_' + i);
                                            if (control.Data.Touch[i]) {
                                                stickFloat.attr('transform', 'translate(' + (6 + (64 + control.Data.X[i] * 63) * ratioW) + ',' + (6 + (64 + control.Data.Y[i] * 63) * ratioH) + ')');
                                                stickFloat.children('.pad_float_text').attr('transform', 'translate(' + (control.Data.X[i] > 0 ? -6 : 6) + ',' + (control.Data.Y[i] > 0 ? -6 : 6) + ')');
                                                stickFloat.show();
                                            } else {
                                                stickFloat.hide();
                                            }
                                        }
                                        if (control.Data.HasClick) if (control.Data.Click) ctrl.find('.pad_click').addClass('active-o'); else ctrl.find('.pad_click').removeClass('active-o', 'disable-o'); else ctrl.find('.pad_click').addClass('disable-o');
                                    }
                                    break;
                                case 'ExtendInput.Controls.ControlButtonGrid':
                                    {
                                        var renderElement = wrapper.find('.control-value');
                                        renderElement.addClass('text-center');
                                        if (NewSubtype || renderElement.children('svg').length == 0) {
                                            var domString =
                                                '<svg id="control_render_' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                                '<g>';
                                            for (var x = 0; x < control.Data.Button.length; x++) {
                                                for (var y = 0; y < control.Data.Button[0].length; y++) {
                                                    var sizeX = 136 / control.Data.Button.length;
                                                    var sizeY = 136 / control.Data.Button[0].length;
                                                    domString += '<path class="btn_' + x + '_' + y + '" d="M ' + (1 + sizeX * x) + ',' + (1 + sizeY * y) + ' m 0,' + sizeX + ' ' + sizeY + ',0 0,-' + sizeX + ' -' + sizeY + ',0 z" stroke="#999" fill="none" stroke-width="2"></path>';
                                                }
                                            }
                                            domString +=
                                                '</g>' +
                                                '</svg>'
                                            renderElement.empty().append(domString);
                                        }
                                        var ctrl = $('#control_render_' + control_id);
                                        '<g>';
                                        for (var x = 0; x < control.Data.Button.length; x++) {
                                            for (var y = 0; y < control.Data.Button[0].length; y++) {
                                                if (control.Data.Button[x][y]) ctrl.find('.btn_' + x + '_' + y).addClass('active'); else ctrl.find('.btn_' + x + '_' + y).removeClass('active');
                                            }
                                        }
                                        //var stickFloat = ctrl.find('.stick_float');
                                        //stickFloat.attr('cx', 70 + control.Data.X * 63);
                                        //stickFloat.attr('cy', 70 + control.Data.Y * 63);
                                        //if (control.Data.HasClick) if (control.Data.Click) ctrl.find('.stick_click').addClass('active-o'); else ctrl.find('.stick_click').removeClass('active-o', 'disable-o'); else ctrl.find('.stick_click').addClass('disable-o');
                                    }
                                    break;
                                default:
                                    wrapper.find('.control-value').addClass('text-monospace small').text(JSON.stringify(control.Data, null, 2));
                                    break;
                            }

                            if (existing.length == 0) {
                                $state_data.append(wrapper);
                            }
                        }
                        for (const control_id in knownChildren) {
                            $state_data.children('#' + control_id).remove();
                        }
                    }).done(function () {
                        if (ControllerActive)
                            PollControllerFunc();
                    });
                }
            }

            function PollOtherFunc() {
                $.get("/poll_other", function (data) {
                    var knownChildren = {};
                    $controllers.children().each((i, elem) => knownChildren[elem.id] = true);
                    for (const controller_id in data.Controllers) {
                        var controller = data.Controllers[controller_id];

                        var ConnectionIcon = null;
                        for (var idx in controller.ConnectionTypeCode) {
                            var code = controller.ConnectionTypeCode[idx];
                            if (data.IconImages[code] != null) {
                                ConnectionIcon = data.IconImages[code];
                                break;
                            }
                        }

                        var ControllerIcon = null;
                        var ControllerImage = null;
                        for (var idx in controller.ControllerTypeCode) {
                            var code = controller.ControllerTypeCode[idx];
                            if (ControllerIcon == null && data.IconImages[code] != null) {
                                ControllerIcon = data.IconImages[code];
                            }
                            if (ControllerImage == null && data.ControllerImages[code] != null) {
                                ControllerImage = data.ControllerImages[code];
                            }
                            if (ControllerIcon != null && ControllerImage != null)
                                break;
                        }

                        var existing = $controllers.children('#controller_' + controller_id);
                        if (existing.length == 0) {
                            //var wrapper = $('<div class="controller col-md-6 col-lg-4 pb-4"/>');
                            var wrapper = $('<div class="controller col-12 pb-4"/>');
                            wrapper.attr('id', 'controller_' + controller_id);
                            var cardWrapper = $('<div class="card" />');
                            if (ControllerImage != null) {
                                var cardImage = $('<img class="controller_image" />');
                                cardImage.attr("src", "/images/controller/" + ControllerImage);
                                cardImage.attr("alt", controller.Name);
                                cardWrapper.append(cardImage);
                            } else {
                                var cardImage = $('<img class="controller_image" />');
                                cardImage.attr("src", "/images/controller/placeholder.png");
                                cardImage.attr("alt", controller.Name);
                                cardWrapper.append(cardImage);
                            }

                            cardWrapper.append('<div class="card-body"><h5 class="card-title"><img class="connection_icon" /><img class="controller_icon" /><span class="controller_name"></span></h5><p class="card-text" style="white-space:pre;"></p></div>');

                            if (ControllerIcon != null) {
                                var cardImage = cardWrapper.find('.controller_icon');
                                cardImage.attr("src", "/images/icons/" + ControllerIcon);
                                cardImage.attr("alt", controller.Name);
                            } else {
                                var cardImage = cardWrapper.find('.controller_icon');
                                cardImage.attr("src", "/images/icons/DEVICE_UNKNOWN.png");
                                cardImage.attr("alt", controller.Name);
                            }
                            if (ConnectionIcon != null) {
                                var cardImage = cardWrapper.find('.connection_icon');
                                cardImage.attr("src", "/images/icons/" + ConnectionIcon);
                                cardImage.attr("alt", controller.Name);
                            } else {
                                var cardImage = cardWrapper.find('.connection_icon');
                                cardImage.attr("src", "/images/icons/DEVICE_UNKNOWN.png");
                                cardImage.attr("alt", controller.Name);
                            }

                            if (controller.HasSelectableAlternatives) {
                                var menu = $('<div class="list-group small alternate_controller_list" />');
                                menu.append('<h6 class="list-group-item">Alternate Controllers</h6>');
                                for (var alternate in controller.Alternates) {
                                    var alternate_item = $('<a class="alternate_controller list-group-item list-group-item-action" href="#" />');
                                    alternate_item.attr('data-id', alternate);
                                    alternate_item.text(controller.Alternates[alternate]);
                                    menu.append(alternate_item);
                                }
                                var alternateBody = $('<div class="card-body" />');
                                alternateBody.append(menu);
                                cardWrapper.append(alternateBody);
                            }

                            cardWrapper.append('<a href="#" class="btn btn-primary btn-lg btn-block activate_controller" role="button" data-id="' + controller_id + '"></a>');
                            wrapper.append(cardWrapper);
                        } else {
                            wrapper = existing;
                            delete knownChildren['controller_' + controller_id];

                            var menu = wrapper.find('.alternate_controller_list');
                            for (var alternate in controller.Alternates) {
                                if (menu.children('.alternate_controller[data-id="' + alternate + '"]').length == 0) {
                                    var alternate_item = $('<a class="alternate_controller list-group-item list-group-item-action" href="#" />');
                                    alternate_item.attr('data-id', alternate);
                                    alternate_item.text(controller.Alternates[alternate]);
                                    menu.append(alternate_item);
                                }
                            }

                            if (ControllerImage != null) {
                                var cardImage = wrapper.find('.controller_image');
                                cardImage.attr("src", "/images/controller/" + ControllerImage);
                                cardImage.attr("alt", controller.Name);
                            } else {
                                var cardImage = wrapper.find('.controller_image');
                                cardImage.attr("src", "/images/controller/placeholder.png");
                                cardImage.attr("alt", controller.Name);
                            }

                            if (ControllerIcon != null) {
                                var cardImage = wrapper.find('.controller_icon');
                                cardImage.attr("src", "/images/icon/" + ControllerIcon);
                                cardImage.attr("alt", controller.Name);
                            } else {
                                var cardImage = wrapper.find('.controller_icon');
                                cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                                cardImage.attr("alt", controller.Name);
                            }
                            if (ConnectionIcon != null) {
                                var cardImage = wrapper.find('.connection_icon');
                                cardImage.attr("src", "/images/icon/" + ConnectionIcon);
                                cardImage.attr("alt", controller.Name);
                            } else {
                                var cardImage = wrapper.find('.connection_icon');
                                cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                                cardImage.attr("alt", controller.Name);
                            }
                        }

                        var knownAlternates = {};
                        var alternate_controller_list_dom = wrapper.find('.alternate_controller_list');
                        alternate_controller_list_dom.children('.alternate_controller').each((i, elem) => knownAlternates[$(elem).data('id')] = true);
                        for (const alternate in knownAlternates) {
                            if (!controller.Alternates[alternate])
                                alternate_controller_list_dom.children('.alternate_controller[data-id="' + alternate + '"]').remove();
                        }


                        wrapper.find('.controller_name').text(controller.Name);
                        if (controller.NameDetails != null) {
                            wrapper.find('.card-text').text(controller.NameDetails.join('\r\n'));
                        } else {
                            wrapper.find('.card-text').text('');
                        }

                        if (existing.length == 0) {
                            $controllers.append(wrapper);
                        }
                    }
                    for (const controller_id in knownChildren) {
                        //if (controller_id == "controller_state") continue;
                        $controllers.children('#' + controller_id).remove();
                    }
                }).done(setTimeout(function () { PollOtherFunc() }, 1000));
            }
            PollOtherFunc();
        });
    </script>
</body>
</html>