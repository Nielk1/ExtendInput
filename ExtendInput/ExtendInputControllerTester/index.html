<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <style>
        svg .active {
            fill: #333;
        }

        svg .active-low {
            fill: #ccc;
        }

        svg .disable {
            fill: red;
        }

        svg .active-o {
            stroke: #333;
        }

        svg .disable-o {
            stroke: red;
        }

        div.wheel_click {
            border: solid 3px #999;
        }
        div.wheel_click.active-o {
            border-color: #333;
        }
        div.wheel_click.disable-o {
            border-color: red;
        }

        .controller_icon,
        .connection_icon {
            width: auto;
            height: 32px;
            padding-right: 5px;
        }

        #controllers {
            overflow: hidden;
        }
        #controllers_wrapper {
            float: left;
            width: 400px;
            height: 100vh;
            overflow-y: scroll;
            position: fixed;
            margin-top: -5px;
            padding-top: 5px;
        }

        #state_data {
            padding-left: 400px;
            /*margin-left: 5px;
            margin-right: 5px;*/
            margin: 5px;
        }
        .activate_controller::after {
            content: "Activate";
        }
        .controller-active .activate_controller::after {
            content: "Deactivate";
        }

        .chord_text {
            font-size: 0.6em;
            font-family: monospace;
            white-space: pre;
        }

        .controller_image {
            padding: 5px;
        }

        div.model {
            height: 150px;
        }

        .spin {
            padding: 5px;
            animation: spin 0s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(-360deg);
            }
        }

        /*(xs: 0, sm: 576px, md: 768px, lg: 992px, xl: 1200px)*/
        /*@media (min-width: 0) and (max-width: 576px) {
            .card-columns {
                column-count: 2;
            }
        }*/

        .spinner {
            transition-timing-function: linear;
            transition-duration: 0.05s;
        }

        .wheel {
            perspective: none;
            border: 1px solid #333;
            margin: 0 auto;
            width: 30px;
            height: 100px;
            overflow: hidden;
        }

        .wheel__inner {
            position: relative;
            width: 100%;
            height: 100%;
            margin: 0 auto;
            transform-style: preserve-3d;
            transition-timing-function: linear;
            transition-duration: 0.1s;
        }

        .wheel__segment
        {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 40px;
            position: absolute;
            top: 50%;
            background-color: #fff;
            border-top: solid black 1px;
        }
    </style>

    <title>Hello, world!</title>
</head>
<body>
    <div class="fluid-container">
        <div class="" id="controllers_wrapper">
            <div class=" col-12 pb-4">
                <div class="list-group" id="manual"></div>
            </div>
            <div class="" id="controllers"></div>
        </div>
        <!--<div class="row" id="state_data"></div>-->
        <div class="card-columns" id="state_data"></div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>

    <!--<script src="3d/three.min.js"></script>
    <script src="3d/OrbitControls.js"></script>
    <script src="3d/ColladaLoader.js"></script>-->

    <script>
        var socket = null;

        var ControllerImages = {};
        var IconImages = {};

        const cyrb53 = function (str, seed = 0) {
            let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
            for (let i = 0, ch; i < str.length; i++) {
                ch = str.charCodeAt(i);
                h1 = Math.imul(h1 ^ ch, 2654435761);
                h2 = Math.imul(h2 ^ ch, 1597334677);
            }
            h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507) ^ Math.imul(h2 ^ (h2 >>> 13), 3266489909);
            h2 = Math.imul(h2 ^ (h2 >>> 16), 2246822507) ^ Math.imul(h1 ^ (h1 >>> 13), 3266489909);
            return 4294967296 * (2097151 & h2) + (h1 >>> 0);
        };

        function DrawButtonSvg(name, x, y) {
            return '<ellipse class="' + name + '" ry="29" rx="29" cy="' + y + '" cx="' + x + '" stroke="#000" fill="#fff" />' +
                '<ellipse class="' + name + '_data" ry="0" rx="0" cy="' + y + '" cx="' + x + '" stroke="#000" fill="#333" />';
        }
        function UpdateButtonSvg(ctrl, name, val) {
            ctrl.find(name).attr('rx', val * 29).attr('ry', val * 29);
        }
        function DrawButton2StageSvg(name, x, y) {
            return '<ellipse class="' + name + '_click" ry="29" rx="29" cy="' + y + '" cx="' + x + '" stroke="#ccc" fill="none" stroke-width="3" />' +
                '<ellipse class="' + name + '" ry="25" rx="25" cy="' + y + '" cx="' + x + '" stroke="#000" fill="#fff" />' +
                '<ellipse class="' + name + '_data" ry="0" rx="0" cy="' + y + '" cx="' + x + '" stroke="#000" fill="#333" />';
        }
        function UpdateButton2StageSvg(ctrl, name, val) {
            ctrl.find(name).attr('rx', val * 25).attr('ry', val * 25);
        }

        function RenderControl(ConnectionUniqueID, controller_id, control_id, controlData, controlType, $state_data, NewSubtype, knownChildren, childWidth) {
            var existing = $state_data.children('#state_' + controller_id + '__' + control_id);
            //var control = data.controls[control_id];

            if (existing.length == 0) {
                //var wrapper = $('<div class="col-sm-6 col-md-4 col-lg-3 pb-4"/>');
                //var wrapper = childWidth ? $('<div class="control_state col-12 pb-4"/>') : $('<div class="control_state col-sm-12 col-md-12 col-lg-6 col-xl-4 pb-4"/>');
                var wrapper = $('<div class="control_state"/>');
                wrapper.attr('id', 'state_' + controller_id + '__' + control_id);
                wrapper.attr('data-id', controller_id + '__' + control_id);
                wrapper.attr('data-control-id', control_id);
                wrapper.attr('data-controller-id', controller_id);
                wrapper.attr('data-controller', ConnectionUniqueID);
                wrapper.append('<div class="card"><div class="pb-3"><h5 class="card-title text-center">' + control_id.replace('-', ':') + '</h5><div class="control_type card-title text-center small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + controlType + '</div><div class="card-text control-value" style="white-space:pre;"></div></div></div>');
            } else {
                wrapper = existing;
                var controlTypeD = wrapper.find('.control_type');
                if (controlTypeD.text() != controlType)
                    controlTypeD.text(controlType);
                delete knownChildren['state_' + controller_id + '__' + control_id];
            }

            switch (controlType == null ? controlType : controlType.split('[')[0]) {
                case 'ExtendInput.Controls.ControlButtonQuad':
                case 'ExtendInput.Controls.IControlButtonQuad':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="182" height="182" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                DrawButtonSvg("btn_n", 91, 31) +
                                DrawButtonSvg("btn_e", 151, 91) +
                                DrawButtonSvg("btn_s", 91, 151) +
                                DrawButtonSvg("btn_w", 31, 91) +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        if (controlData.ButtonN) {
                            UpdateButtonSvg(ctrl, '.btn_n_data', 1);
                        } else {
                            UpdateButtonSvg(ctrl, '.btn_n_data', 0);
                        }
                        if (controlData.ButtonE) {
                            UpdateButtonSvg(ctrl, '.btn_e_data', 1);
                        } else {
                            UpdateButtonSvg(ctrl, '.btn_e_data', 0);
                        }
                        if (controlData.ButtonS) {
                            UpdateButtonSvg(ctrl, '.btn_s_data', 1);
                        } else {
                            UpdateButtonSvg(ctrl, '.btn_s_data', 0);
                        }
                        if (controlData.ButtonW) {
                            UpdateButtonSvg(ctrl, '.btn_w_data', 1);
                        } else {
                            UpdateButtonSvg(ctrl, '.btn_w_data', 0);
                        }
                    }
                    break;

                case 'ExtendInput.Controls.ControlButtonQuadPressure':
                case 'ExtendInput.Controls.IControlButtonQuadPressure':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="182" height="182" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                DrawButtonSvg("btn_n", 91, 31) +
                                DrawButtonSvg("btn_e", 151, 91) +
                                DrawButtonSvg("btn_s", 91, 151) +
                                DrawButtonSvg("btn_w", 31, 91) +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        if (controlData.ButtonN) {
                            ctrl.find('.btn_n').addClass('active-low');
                        } else {
                            ctrl.find('.btn_n').removeClass('active-low');
                        }
                        if (controlData.ButtonE) {
                            ctrl.find('.btn_e').addClass('active-low');
                        } else {
                            ctrl.find('.btn_e').removeClass('active-low');
                        }
                        if (controlData.ButtonS) {
                            ctrl.find('.btn_s').addClass('active-low');
                        } else {
                            ctrl.find('.btn_s').removeClass('active-low');
                        }
                        if (controlData.ButtonW) {
                            ctrl.find('.btn_w').addClass('active-low');
                        } else {
                            ctrl.find('.btn_w').removeClass('active-low');
                        }
                        UpdateButtonSvg(ctrl, '.btn_n_data', controlData.AButtonN);
                        UpdateButtonSvg(ctrl, '.btn_e_data', controlData.AButtonE);
                        UpdateButtonSvg(ctrl, '.btn_s_data', controlData.AButtonS);
                        UpdateButtonSvg(ctrl, '.btn_w_data', controlData.AButtonW);
                    }
                    break;
                case 'ExtendInput.Controls.ControlButtonQuadSlider':
                case 'ExtendInput.Controls.IControlButtonQuadSlider':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="224" height="224" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                '<g filter="url(#shadow)">' +
                                '</g>' +
                                '<rect x="19" y="19" width="187" height="187" rx="50" ry="50" stroke="#000" fill="#fff" transform="rotate(45,112,112)"></rect>' +
                                (controlData.MovableButtonN ? '' : DrawButtonSvg("btn_n", 112, 53)) +
                                (controlData.MovableButtonE ? '' : DrawButtonSvg("btn_e", 172, 113)) +
                                (controlData.MovableButtonS ? '' : DrawButtonSvg("btn_s", 112, 173)) +
                                (controlData.MovableButtonW ? '' : DrawButtonSvg("btn_w", 52, 113)) +
                                '<g class="stick_float">' +
                                (controlData.MovableButtonN ? DrawButtonSvg("btn_n", 112, 53) : '') +
                                (controlData.MovableButtonE ? DrawButtonSvg("btn_e", 172, 113) : '') +
                                (controlData.MovableButtonS ? DrawButtonSvg("btn_s", 112, 173) : '') +
                                (controlData.MovableButtonW ? DrawButtonSvg("btn_w", 52, 113) : '') +
                                '<text class="chord_text stick_float_text" x="112" y="112" style="text-anchor: middle;" transform="translate(0,0)"></text>' +
                                '</g>' +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        if (controlData.ButtonN) {
                            UpdateButtonSvg(ctrl, '.btn_n_data', 1);
                        } else {
                            UpdateButtonSvg(ctrl, '.btn_n_data', 0);
                        }
                        if (controlData.ButtonE) {
                            UpdateButtonSvg(ctrl, '.btn_e_data', 1);
                        } else {
                            UpdateButtonSvg(ctrl, '.btn_e_data', 0);
                        }
                        if (controlData.ButtonS) {
                            UpdateButtonSvg(ctrl, '.btn_s_data', 1);
                        } else {
                            UpdateButtonSvg(ctrl, '.btn_s_data', 0);
                        }
                        if (controlData.ButtonW) {
                            UpdateButtonSvg(ctrl, '.btn_w_data', 1);
                        } else {
                            UpdateButtonSvg(ctrl, '.btn_w_data', 0);
                        }
                        var stickFloat = ctrl.find('.stick_float');
                        stickFloat.attr('transform', 'translate(' + (controlData.X * 20) + ',' + (controlData.Y * 20) + ')');
                        stickFloat.children('.stick_float_text').text(cord_formatter.format(controlData.X) + ',' + cord_formatter.format(controlData.Y));
                    }
                    break;

                case 'ExtendInput.Controls.ControlControlButtonSfxFlower':
                case 'ExtendInput.Controls.IControlControlButtonSfxFlower':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="222" height="222" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                DrawButtonSvg("btn_n", 111, 31) +
                                '<path class="btn_ne" d="M 111,111 m 60,-60 -50,20 30,30 z" stroke="#000" fill="#fff"></path>' +
                                DrawButtonSvg("btn_e", 191, 111) +
                                '<path class="btn_se" d="M 111,111 m 60,60 -50,-20 30,-30 z" stroke="#000" fill="#fff"></path>' +
                                DrawButtonSvg("btn_s", 111, 191) +
                                '<path class="btn_sw" d="M 111,111 m -60,60 20,-50 30,30 z" stroke="#000" fill="#fff"></path>' +
                                DrawButtonSvg("btn_w", 31, 111) +
                                '<path class="btn_nw" d="M 111,111 m -60,-60 20,50 30,-30 z" stroke="#000" fill="#fff"></path>' +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        if (controlData.ButtonN) { UpdateButtonSvg(ctrl, '.btn_n_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_n_data', 0); }
                        if (controlData.ButtonNE) { ctrl.find('.btn_ne').addClass('active'); } else { ctrl.find('.btn_ne').removeClass('active'); }
                        if (controlData.ButtonE) { UpdateButtonSvg(ctrl, '.btn_e_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_e_data', 0); }
                        if (controlData.ButtonSE) { ctrl.find('.btn_se').addClass('active'); } else { ctrl.find('.btn_se').removeClass('active'); }
                        if (controlData.ButtonS) { UpdateButtonSvg(ctrl, '.btn_s_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_s_data', 0); }
                        if (controlData.ButtonSW) { ctrl.find('.btn_sw').addClass('active'); } else { ctrl.find('.btn_sw').removeClass('active'); }
                        if (controlData.ButtonW) { UpdateButtonSvg(ctrl, '.btn_w_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_w_data', 0); }
                        if (controlData.ButtonNW) { ctrl.find('.btn_nw').addClass('active'); } else { ctrl.find('.btn_nw').removeClass('active'); }
                    }
                    break;

                case 'ExtendInput.Controls.ControlButtonGenesis3':
                case 'ExtendInput.Controls.IControlButtonGenesis3':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="202" height="122" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                DrawButtonSvg("btn_a", 31 + 10 + 10, 91) +
                                DrawButtonSvg("btn_b", 91 + 10 + 10, 91 - 30) +
                                DrawButtonSvg("btn_c", 151 + 10 + 10, 31) +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        if (controlData.ButtonA) { UpdateButtonSvg(ctrl, '.btn_a_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_a_data', 0); }
                        if (controlData.ButtonB) { UpdateButtonSvg(ctrl, '.btn_b_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_b_data', 0); }
                        if (controlData.ButtonC) { UpdateButtonSvg(ctrl, '.btn_c_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_c_data', 0); }

                    }
                    break;

                case 'ExtendInput.Controls.ControlButtonGenesis6':
                case 'ExtendInput.Controls.IControlButtonGenesis6':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="202" height="182" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                DrawButtonSvg("btn_a", 31 + 10 + 10, 151) +
                                DrawButtonSvg("btn_b", 91 + 10 + 10, 91 + 30) +
                                DrawButtonSvg("btn_c", 151 + 10 + 10, 91) +
                                DrawButtonSvg("btn_x", 31 - 10 + 10, 91) +
                                DrawButtonSvg("btn_y", 91 - 10 + 10, 91 - 30) +
                                DrawButtonSvg("btn_z", 151 - 10 + 10, 31) +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        if (controlData.ButtonA) { UpdateButtonSvg(ctrl, '.btn_a_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_a_data', 0); }
                        if (controlData.ButtonB) { UpdateButtonSvg(ctrl, '.btn_b_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_b_data', 0); }
                        if (controlData.ButtonC) { UpdateButtonSvg(ctrl, '.btn_c_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_c_data', 0); }
                        if (controlData.ButtonX) { UpdateButtonSvg(ctrl, '.btn_x_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_x_data', 0); }
                        if (controlData.ButtonY) { UpdateButtonSvg(ctrl, '.btn_y_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_y_data', 0); }
                        if (controlData.ButtonZ) { UpdateButtonSvg(ctrl, '.btn_z_data', 1); } else { UpdateButtonSvg(ctrl, '.btn_z_data', 0); }

                    }
                    break;
                case 'ExtendInput.Controls.ControlButton':
                case 'ExtendInput.Controls.IControlButton':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="62" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                DrawButtonSvg("btn_x", 31, 31) +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        if (controlData.DigitalStage1) {
                            UpdateButtonSvg(ctrl, '.btn_x_data', 1);
                        } else {
                            UpdateButtonSvg(ctrl, '.btn_x_data', 0);
                        }
                    }
                    break;
                case 'ExtendInput.Controls.ControlButtonPS5Mute':
                case 'ExtendInput.Controls.ControlButtonLightToggle':
                case 'ExtendInput.Controls.IControlButtonWithStateLight':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="62" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                '<ellipse class="" ry="29" rx="29" cy="' + 31 + '" cx="' + 31 + '" stroke="#000" fill="#fff" />' +
                                '<ellipse class="btn_x_data" ry="0" rx="0" cy="' + 31 + '" cx="' + 31 + '" stroke="#000" fill="#333" />' +
                                '</g>' +
                                '</svg>');
                            var listElement = $('<div class="list-group p-1 control_state_list" id="control_state_list_' + controller_id + '__' + control_id + '"/>');
                            renderElement.append(listElement);
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        var listElement = $('#control_state_list_' + controller_id + '__' + control_id);
                        if (controlData.States.length != listElement.children().length) {
                            listElement.empty();
                        } else {
                            for (var idx in controlData.States) {
                                if (listElement.find('a[data-id="' + controlData.States[idx] + '"]').length == 0) {
                                    listElement.empty();
                                    break;
                                }
                            }
                        }
                        if (controlData.States.length != listElement.children().length) {
                            for (var idx in controlData.States) {
                                listElement.append('<a href="#" class="list-group-item list-group-item-action' + (controlData.States[idx] == controlData.State ? ' active' : '') + '" data-id="' + controlData.States[idx] + '">' + controlData.States[idx] + '</a>');
                            }
                        } else {
                            listElement.find('[data-id="' + controlData.State + '"]').addClass('active');
                            listElement.find('.active[data-id][data-id!="' + controlData.State + '"]').removeClass('active');
                        }
                        if (controlData.DigitalStage1) {
                            ctrl.find(".btn_x_data").attr('rx', 29).attr('ry', 29);
                        } else {
                            ctrl.find(".btn_x_data").attr('rx', 0).attr('ry', 0);
                        }
                    }
                    break;
                case 'ExtendInput.Controls.ControlButtonLightBrightness':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="62" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                '<ellipse class="" ry="29" rx="29" cy="' + 31 + '" cx="' + 31 + '" stroke="#000" fill="#fff" />' +
                                '<ellipse class="btn_x_data" ry="0" rx="0" cy="' + 31 + '" cx="' + 31 + '" stroke="#000" fill="#333" />' +
                                '</g>' +
                                '</svg>');
                            var inputsWrapperElement = $('<div class="form-group" id="control_property_list_' + controller_id + '__' + control_id + '"/>');
                            inputsWrapperElement.append('<label class="small mb-0">Brightness</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="Brightness" class="control_property_item form-control-range" value="' + controlData.Brightness + '" min="0" max="1" step="' + (1 / controlData.Levels) + '" \>');
                            renderElement.append(inputsWrapperElement);
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        var listElement = $('#control_state_list_' + controller_id + '__' + control_id);
                        listElement.find('[data-id="Brightness"]').addClass('active');
                        listElement.find('.active[data-id][data-id!="Brightness"]').removeClass('active');
                        if (controlData.DigitalStage1) {
                            ctrl.find(".btn_x_data").attr('rx', 29).attr('ry', 29);
                        } else {
                            ctrl.find(".btn_x_data").attr('rx', 0).attr('ry', 0);
                        }
                    }
                    break;

                case 'ExtendInput.Controls.ControlTriggerPS5':
                    {
                        var TriggerEffectInputEnables = {
                            STATE_PS5_TRIGGER_NONE: "00000",
                            STATE_PS5_TRIGGER_FEEDBACK: "10100",
                            STATE_PS5_TRIGGER_WEAPON: "11100",
                            STATE_PS5_TRIGGER_VIBRATION: "10011"
                        }

                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="76" height="86" xmlns="http://www.w3.org/2000/svg">' +
                                '<defs><clipPath id="guagePath"><path d="M 70 6 l 64 0 a 64 64 90 0 1 -64 64 z" /></clipPath></defs>' +
                                '<g>' +
                                '<path transform="translate(-64,0)" class="btn_x"      d="M 70 6 l 64 0 a 64 64 90 0 1 -64 64 z" stroke="" fill="#fff"></path>' +
                                '<g transform="translate(-64,0)" clip-path="url(#guagePath)">' +
                                '<circle class="btn_x_data2" r="64" cx="70" cy="6" fill="transparent" stroke="#aaa" stroke-width="128" stroke-dasharray="calc(3.14 * 64) calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                '<circle class="btn_x_data" r="64" cx="70" cy="6" fill="transparent" stroke="#333" stroke-width="128" stroke-dasharray="9 calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                '</g>' +
                                '<path transform="translate(-64,0)" class="btn_x_border"      d="M 70 6 l 64 0 a 64 64 90 0 1 -64 64 z" stroke="#000" fill="transparent"></path>' +
                                '<text class="btn_text chord_text" x="38" y="82" text-anchor="middle">0.000%</text>' +
                                '</g>' +
                                '</svg>');
                            var inputsWrapperElement = $('<div class="form-group" id="control_property_list_' + controller_id + '__' + control_id + '"/>');
                            var listElement = $('<div class="list-group p-1 control_property_list"/>');
                            listElement.append('<a href="#" class="list-group-item list-group-item-action control_property_item" data-property="Effect" data-value="STATE_PS5_TRIGGER_NONE">STATE_PS5_TRIGGER_NONE</a>');
                            listElement.append('<a href="#" class="list-group-item list-group-item-action control_property_item" data-property="Effect" data-value="STATE_PS5_TRIGGER_FEEDBACK">STATE_PS5_TRIGGER_FEEDBACK</a>');
                            listElement.append('<a href="#" class="list-group-item list-group-item-action control_property_item" data-property="Effect" data-value="STATE_PS5_TRIGGER_WEAPON">STATE_PS5_TRIGGER_WEAPON</a>');
                            listElement.append('<a href="#" class="list-group-item list-group-item-action control_property_item" data-property="Effect" data-value="STATE_PS5_TRIGGER_VIBRATION">STATE_PS5_TRIGGER_VIBRATION</a>');
                            inputsWrapperElement.append(listElement);
                            inputsWrapperElement.append('<label class="small mb-0">Start</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="Start"      class="control_property_item form-control-range" value="' + controlData.Start + '" min="0" max="9"\>');
                            inputsWrapperElement.append('<label class="small mb-0">End</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="End"        class="control_property_item form-control-range" value="' + controlData.End + '" min="0" max="9"\>');
                            inputsWrapperElement.append('<label class="small mb-0">Strength</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="Strength"   class="control_property_item form-control-range" value="' + controlData.Strength + '" min="0" max="8"\>');
                            inputsWrapperElement.append('<label class="small mb-0">Amplitude</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="Amplitude"  class="control_property_item form-control-range" value="' + controlData.Amplitude + '" min="0" max="8"\>');
                            inputsWrapperElement.append('<label class="small mb-0">Frequency</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="Frequency"  class="control_property_item form-control-range" value="' + controlData.Frequency + '" min="0" max="255"\>');
                            renderElement.append(inputsWrapperElement);
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        ctrl.find('.btn_text').text(controlData.AnalogStage1.toFixed(3).padStart(6, ' ') + '%');
                        if (Math.abs(controlData.AnalogStage1) < 0.01) {
                            ctrl.find('.btn_x_data').attr('transform', 'rotate(86 70 6)');
                        } else {
                            ctrl.find('.btn_x_data').show().attr('transform', 'rotate(' + (86 + controlData.AnalogStage1 * -90) + ' 70 6)');
                        }
                        ctrl.find('.btn_x_data2').attr('transform', 'rotate(' + (86 + controlData.TriggerStop / 9.0 * -90 + -180) + ' 70 6)');
                        switch (controlData.TriggerStatus) {
                            case 0: ctrl.find('.btn_x_data').attr('stroke', '#333'); break;
                            case 1: ctrl.find('.btn_x_data').attr('stroke', 'orange'); break;
                            case 2: ctrl.find('.btn_x_data').attr('stroke', 'red'); break;
                        }

                        var listElement = $('#control_property_list_' + controller_id + '__' + control_id);
                        listElement.find('[data-value="' + controlData.Effect + '"]').addClass('active');
                        listElement.find('.active[data-value][data-value!="' + controlData.Effect + '"]').removeClass('active');
                    }
                    break;

                case 'ExtendInput.Controls.ControlTriggerFlydigi':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="76" height="86" xmlns="http://www.w3.org/2000/svg">' +
                                '<defs><clipPath id="guagePath"><path d="M 70 6 l 64 0 a 64 64 90 0 1 -64 64 z" /></clipPath></defs>' +
                                '<g>' +
                                '<path transform="translate(-64,0)" class="btn_x"      d="M 70 6 l 64 0 a 64 64 90 0 1 -64 64 z" stroke="" fill="#fff"></path>' +
                                '<g transform="translate(-64,0)" clip-path="url(#guagePath)">' +
                                //'<circle class="btn_x_data2" r="64" cx="70" cy="6" fill="transparent" stroke="#aaa" stroke-width="128" stroke-dasharray="calc(3.14 * 64) calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                '<circle class="btn_x_data" r="64" cx="70" cy="6" fill="transparent" stroke="#333" stroke-width="128" stroke-dasharray="9 calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                '</g>' +
                                '<path transform="translate(-64,0)" class="btn_x_border"      d="M 70 6 l 64 0 a 64 64 90 0 1 -64 64 z" stroke="#000" fill="transparent"></path>' +
                                '<text class="btn_text chord_text" x="38" y="82" text-anchor="middle">0.000%</text>' +
                                '</g>' +
                                '</svg>');
                            var inputsWrapperElement = $('<div class="form-group" id="control_property_list_' + controller_id + '__' + control_id + '"/>');
                            var listElement = $('<div class="list-group p-1 control_property_list"/>');
                            listElement.append('<a href="#" class="list-group-item list-group-item-action control_property_item" data-property="Effect" data-value="STATE_FLYDIGI_TRIGGER_NONE">STATE_FLYDIGI_TRIGGER_NONE</a>');
                            listElement.append('<a href="#" class="list-group-item list-group-item-action control_property_item" data-property="Effect" data-value="STATE_FLYDIGI_TRIGGER_FEEDBACK">STATE_FLYDIGI_TRIGGER_FEEDBACK</a>');
                            listElement.append('<a href="#" class="list-group-item list-group-item-action control_property_item" data-property="Effect" data-value="STATE_FLYDIGI_TRIGGER_VIBRATION">STATE_FLYDIGI_TRIGGER_VIBRATION</a>');
                            listElement.append('<a href="#" class="list-group-item list-group-item-action control_property_item" data-property="Effect" data-value="STATE_FLYDIGI_TRIGGER_WEAPON">STATE_FLYDIGI_TRIGGER_WEAPON</a>');
                            inputsWrapperElement.append(listElement);
                            inputsWrapperElement.append('<label class="small mb-0">Start</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="Start"     class="control_property_item form-control-range" value="' + controlData.Start + '" min="0" max="255"\>');
                            inputsWrapperElement.append('<label class="small mb-0">End</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="End"       class="control_property_item form-control-range" value="' + controlData.End + '" min="0" max="255"\>');
                            inputsWrapperElement.append('<label class="small mb-0">Strength</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="Strength"  class="control_property_item form-control-range" value="' + controlData.Strength + '" min="0" max="255"\>');
                            inputsWrapperElement.append('<label class="small mb-0">Amplitude</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="Amplitude" class="control_property_item form-control-range" value="' + controlData.Amplitude + '" min="0" max="255"\>');
                            inputsWrapperElement.append('<label class="small mb-0">Frequency</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="Frequency" class="control_property_item form-control-range" value="' + controlData.Frequency + '" min="0" max="255"\>');
                            renderElement.append(inputsWrapperElement);
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        ctrl.find('.btn_text').text(controlData.AnalogStage1.toFixed(3).padStart(6, ' ') + '%');
                        if (Math.abs(controlData.AnalogStage1) < 0.01) {
                            ctrl.find('.btn_x_data').attr('transform', 'rotate(86 70 6)');
                        } else {
                            ctrl.find('.btn_x_data').show().attr('transform', 'rotate(' + (86 + controlData.AnalogStage1 * -90) + ' 70 6)');
                        }
                        //ctrl.find('.btn_x_data2').attr('transform', 'rotate(' + (86 + controlData.TriggerStop / 9.0 * -90 + -180) + ' 70 6)');
                        //switch (controlData.TriggerStatus) {
                        //    case 0: ctrl.find('.btn_x_data').attr('stroke', '#333'); break;
                        //    case 1: ctrl.find('.btn_x_data').attr('stroke', 'orange'); break;
                        //    case 2: ctrl.find('.btn_x_data').attr('stroke', 'red'); break;
                        //}

                        var listElement = $('#control_property_list_' + controller_id + '__' + control_id);
                        listElement.find('[data-value="' + controlData.Effect + '"]').addClass('active');
                        listElement.find('.active[data-value][data-value!="' + controlData.Effect + '"]').removeClass('active');
                    }
                    break;

                case 'ExtendInput.Controls.ControlTrigger':
                case 'ExtendInput.Controls.IControlTrigger':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="76" height="86" xmlns="http://www.w3.org/2000/svg">' +
                                '<defs><clipPath id="guagePath"><path d="M 70 6 l 64 0 a 64 64 90 0 1 -64 64 z" /></clipPath></defs>' +
                                '<g>' +
                                '<path transform="translate(-64,0)" class="btn_x"      d="M 70 6 l 64 0 a 64 64 90 0 1 -64 64 z" stroke="" fill="#fff"></path>' +
                                '<g transform="translate(-64,0)" clip-path="url(#guagePath)">' +
                                ////'<circle class="btn_x_data3" r="64" cx="70" cy="6" fill="transparent" stroke="#ccc" stroke-width="128" stroke-dasharray="21 calc(3.14 * 128)" transform="rotate(80 70 6)"></circle>' +
                                //'<circle class="btn_x_data3" r="64" cx="70" cy="6" fill="transparent" stroke="#ccc" stroke-width="128" stroke-dasharray="9 calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                ////'<circle class="btn_x_data2" r="64" cx="70" cy="6" fill="transparent" stroke="#aaa" stroke-width="128" stroke-dasharray="15 calc(3.14 * 128)" transform="rotate(83 70 6)"></circle>' +
                                //'<circle class="btn_x_data2" r="64" cx="70" cy="6" fill="transparent" stroke="#aaa" stroke-width="128" stroke-dasharray="9 calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                '<circle class="btn_x_data" r="64" cx="70" cy="6" fill="transparent" stroke="#333" stroke-width="128" stroke-dasharray="9 calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                '</g>' +
                                '<path transform="translate(-64,0)" class="btn_x_border"      d="M 70 6 l 64 0 a 64 64 90 0 1 -64 64 z" stroke="#000" fill="transparent"></path>' +
                                '<text class="btn_text chord_text" x="38" y="82" text-anchor="middle">0.000%</text>' +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        ctrl.find('.btn_text').text(controlData.AnalogStage1.toFixed(3).padStart(6, ' ') + '%');
                        if (Math.abs(controlData.AnalogStage1) < 0.01) {
                            //ctrl.find('.btn_x_data3').attr('transform', 'rotate(80 70 6)');
                            ctrl.find('.btn_x_data3').attr('transform', 'rotate(86 70 6)');
                            //ctrl.find('.btn_x_data2').attr('transform', 'rotate(83 70 6)');
                            ctrl.find('.btn_x_data2').attr('transform', 'rotate(86 70 6)');
                            ctrl.find('.btn_x_data').attr('transform', 'rotate(86 70 6)');
                        } else {
                            //ctrl.find('.btn_x_data3').show().attr('transform', 'rotate(' + (80 + controlData.AnalogStage1 * -84) + ' 70 6)');
                            ctrl.find('.btn_x_data3').show().attr('transform', 'rotate(' + (86 + controlData.AnalogStage1 * -80) + ' 70 6)');
                            //ctrl.find('.btn_x_data2').show().attr('transform', 'rotate(' + (83 + controlData.AnalogStage1 * -87) + ' 70 6)');
                            ctrl.find('.btn_x_data2').show().attr('transform', 'rotate(' + (86 + controlData.AnalogStage1 * -85) + ' 70 6)');
                            ctrl.find('.btn_x_data').show().attr('transform', 'rotate(' + (86 + controlData.AnalogStage1 * -90) + ' 70 6)');
                        }
                    }
                    break;
                case 'ExtendInput.Controls.ControlButtonPressure':
                case 'ExtendInput.Controls.IControlButtonPressure':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="62" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                DrawButtonSvg("btn_x", 31, 31) +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        UpdateButtonSvg(ctrl, '.btn_x_data', controlData.AnalogStage1);
                        if (controlData.DigitalStage1)
                            ctrl.find('.btn_x').addClass('active-low');
                        else
                            ctrl.find('.btn_x').removeClass('active-low');
                    }
                    break;
                case 'ExtendInput.Controls.ControlTrigger2Stage':
                case 'ExtendInput.Controls.IControlTrigger2Stage':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="62" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                DrawButton2StageSvg("btn_x", 31, 31) +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        UpdateButton2StageSvg(ctrl, '.btn_x_data', controlData.AnalogStage1);
                        if (controlData.DigitalStage2) ctrl.find('.btn_x_click').addClass('active-o'); else ctrl.find('.btn_x_click').removeClass('active-o');
                    }
                    break;
                case 'ExtendInput.Controls.ControlDPad':
                case 'ExtendInput.Controls.IControlDPad':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="182" height="182" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                '<path class="btn_n" d="M 091,031 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(180 091 031) translate(-30,-30)"></path>' +
                                '<path class="btn_e" d="M 151,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(-90 151 091) translate(-30,-30)"></path>' +
                                '<path class="btn_s" d="M 091,151 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(0 091 151) translate(-30,-30)"></path>' +
                                '<path class="btn_w" d="M 031,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(90 031 091) translate(-30,-30)"></path>' +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        switch (controlData.Direction) {
                            case "None":
                            case 0: ctrl.find('.btn_n,.btn_e,.btn_s,.btn_w').removeClass('active'); break;
                            case "North":
                            case 1: ctrl.find('       .btn_e,.btn_s,.btn_w').removeClass('active'); ctrl.find('.btn_n                     ').addClass('active'); break;
                            case "NorthEast":
                            case 2: ctrl.find('              .btn_s,.btn_w').removeClass('active'); ctrl.find('.btn_n,.btn_e              ').addClass('active'); break;
                            case "East":
                            case 3: ctrl.find('.btn_n,       .btn_s,.btn_w').removeClass('active'); ctrl.find('       .btn_e              ').addClass('active'); break;
                            case "SouthEast":
                            case 4: ctrl.find('.btn_n,              .btn_w').removeClass('active'); ctrl.find('       .btn_e,.btn_s       ').addClass('active'); break;
                            case "South":
                            case 5: ctrl.find('.btn_n,.btn_e,       .btn_w').removeClass('active'); ctrl.find('              .btn_s       ').addClass('active'); break;
                            case "SouthWest":
                            case 6: ctrl.find('.btn_n,.btn_e              ').removeClass('active'); ctrl.find('              .btn_s,.btn_w').addClass('active'); break;
                            case "West":
                            case 7: ctrl.find('.btn_n,.btn_e,.btn_s       ').removeClass('active'); ctrl.find('                     .btn_w').addClass('active'); break;
                            case "NorthWest":
                            case 8: ctrl.find('       .btn_e,.btn_s       ').removeClass('active'); ctrl.find('.btn_n,              .btn_w').addClass('active'); break;
                        }
                    }
                    break;
                case 'ExtendInput.Controls.ControlDPadPressure':
                case 'ExtendInput.Controls.IControlDPadPressure':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="182" height="182" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                '<path class="btn_n"      d="M 091,031 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(180 091 031) translate(-30,-30)"></path>' +
                                '<path class="btn_n_data" d="M 091,031 m 0,0 30,60 30,-60 z" stroke="#000" fill="#333" transform="rotate(180 091 031) translate(-30,-30)"></path>' +
                                '<path class="btn_e"      d="M 151,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(-90 151 091) translate(-30,-30)"></path>' +
                                '<path class="btn_e_data" d="M 151,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#333" transform="rotate(-90 151 091) translate(-30,-30)"></path>' +
                                '<path class="btn_s"      d="M 091,151 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(0 091 151) translate(-30,-30)"></path>' +
                                '<path class="btn_s_data" d="M 091,151 m 0,0 30,60 30,-60 z" stroke="#000" fill="#333" transform="rotate(0 091 151) translate(-30,-30)"></path>' +
                                '<path class="btn_w"      d="M 031,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(90 031 091) translate(-30,-30)"></path>' +
                                '<path class="btn_w_data" d="M 031,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#333" transform="rotate(90 031 091) translate(-30,-30)"></path>' +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        switch (controlData.Direction) {
                            case "None":
                            case 0: ctrl.find('.btn_n,.btn_e,.btn_s,.btn_w').removeClass('active-low'); break;
                            case "North":
                            case 1: ctrl.find('       .btn_e,.btn_s,.btn_w').removeClass('active-low'); ctrl.find('.btn_n                     ').addClass('active-low'); break;
                            case "NorthEast":
                            case 2: ctrl.find('              .btn_s,.btn_w').removeClass('active-low'); ctrl.find('.btn_n,.btn_e              ').addClass('active-low'); break;
                            case "East":
                            case 3: ctrl.find('.btn_n,       .btn_s,.btn_w').removeClass('active-low'); ctrl.find('       .btn_e              ').addClass('active-low'); break;
                            case "SouthEast":
                            case 4: ctrl.find('.btn_n,              .btn_w').removeClass('active-low'); ctrl.find('       .btn_e,.btn_s       ').addClass('active-low'); break;
                            case "South":
                            case 5: ctrl.find('.btn_n,.btn_e,       .btn_w').removeClass('active-low'); ctrl.find('              .btn_s       ').addClass('active-low'); break;
                            case "SouthWest":
                            case 6: ctrl.find('.btn_n,.btn_e              ').removeClass('active-low'); ctrl.find('              .btn_s,.btn_w').addClass('active-low'); break;
                            case "West":
                            case 7: ctrl.find('.btn_n,.btn_e,.btn_s       ').removeClass('active-low'); ctrl.find('                     .btn_w').addClass('active-low'); break;
                            case "NorthWest":
                            case 8: ctrl.find('       .btn_e,.btn_s       ').removeClass('active-low'); ctrl.find('.btn_n,              .btn_w').addClass('active-low'); break;
                        }
                        ctrl.find('.btn_n_data').css('clip-path', 'inset(0 0 ' + (100 - controlData.AButtonN * 100) + '% 0)');
                        ctrl.find('.btn_e_data').css('clip-path', 'inset(0 0 ' + (100 - controlData.AButtonE * 100) + '% 0)');
                        ctrl.find('.btn_s_data').css('clip-path', 'inset(0 0 ' + (100 - controlData.AButtonS * 100) + '% 0)');
                        ctrl.find('.btn_w_data').css('clip-path', 'inset(0 0 ' + (100 - controlData.AButtonW * 100) + '% 0)');
                    }
                    break;

                case 'ExtendInput.Controls.ControlSlider':
                case 'ExtendInput.Controls.IControlSlider':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="140" height="38" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                '<path class="btn_x"      d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                '<path class="btn_x_data" d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#333"></path>' +
                                '<text class="btn_text chord_text" x="70" y="34" text-anchor="middle">0.000%</text>' +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        ctrl.find('.btn_text').text(controlData.AnalogStage1.toFixed(3) + '%');
                        ctrl.find('.btn_x_data').css('clip-path', 'inset(0 ' + (100 - controlData.AnalogStage1 * 100) + '% 0 0)');
                    }
                    break;

                /*case 'ExtendInput.Controls.ControlCombinedTrigger':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="140" height="86" xmlns="http://www.w3.org/2000/svg">' +
                                '<defs><clipPath id="guagePath"><path d="M 6 6 a 64 64 90 0 0 128 0 z" /></clipPath></defs>' +
                                '<g>' +
                                '<path class="btn_x"      d="M 6 6 a 64 64 90 0 0 128 0 z" stroke="" fill="#fff"></path>' +
                                '<g clip-path="url(#guagePath)">' +
                                '<path class="btn_x_data2" d="M 6 6 a 64 64 90 0 0 128 0 z" stroke="" fill="#ccc" transform="rotate(-90 70 6)"></path>' +
                                '<path class="btn_x_data" d="M 6 6 a 64 64 90 0 0 128 0 z" stroke="" fill="#333" transform="rotate(-90 70 6)"></path>' +
                                '<circle class="middle" r="64" cx="70" cy="6" fill="transparent" stroke="#333" stroke-width="128" stroke-dasharray="8 calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                '</g>' +
                                '<path class="btn_x_border"      d="M 6 6 a 64 64 90 0 0 128 0 z" stroke="#000" fill="transparent"></path>' +
                                '<text class="btn_text chord_text" x="70" y="82" text-anchor="middle">0.000%</text>' +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        ctrl.find('.btn_text').text(controlData.AnalogStage1.toFixed(3).padStart(6, ' ') + '%');
                        if (Math.abs(controlData.AnalogStage1) < 0.01) {
                            ctrl.find('.middle').show();
                            ctrl.find('.btn_x_data').hide();
                            ctrl.find('.btn_x_data2').attr('transform', 'rotate(0 70 70)');
                        } else {
                            ctrl.find('.middle').hide();
                            ctrl.find('.btn_x_data').show().attr('transform', 'rotate(' + (-90 + controlData.AnalogStage1 * -90 + (controlData.AnalogStage1 < 0 ? -180 : 0)) + ' 70 6)');
                            ctrl.find('.btn_x_data2').attr('transform', 'rotate(' + (-90 + controlData.AnalogStage1 * 90 + (controlData.AnalogStage1 > 0 ? 180 : 0)) + ' 70 6)');
                        }
                    }
                    break;*/
                case 'ExtendInput.Controls.ControlCombinedTrigger':
                case 'ExtendInput.Controls.IControlCombinedTrigger':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="140" height="86" xmlns="http://www.w3.org/2000/svg">' +
                                '<defs><clipPath id="guagePath"><path d="M 6 6 a 64 64 90 0 0 128 0 z" /></clipPath></defs>' +
                                '<g>' +
                                '<path class="btn_x"      d="M 6 6 a 64 64 90 0 0 128 0 z" stroke="" fill="#fff"></path>' +
                                '<g clip-path="url(#guagePath)">' +
                                //'<circle class="btn_x_data3" r="64" cx="70" cy="6" fill="transparent" stroke="#ccc" stroke-width="128" stroke-dasharray="21 calc(3.14 * 128)" transform="rotate(80 70 6)"></circle>' +
                                '<circle class="btn_x_data3" r="64" cx="70" cy="6" fill="transparent" stroke="#ccc" stroke-width="128" stroke-dasharray="9 calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                //'<circle class="btn_x_data2" r="64" cx="70" cy="6" fill="transparent" stroke="#aaa" stroke-width="128" stroke-dasharray="15 calc(3.14 * 128)" transform="rotate(83 70 6)"></circle>' +
                                '<circle class="btn_x_data2" r="64" cx="70" cy="6" fill="transparent" stroke="#aaa" stroke-width="128" stroke-dasharray="9 calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                '<circle class="btn_x_data" r="64" cx="70" cy="6" fill="transparent" stroke="#333" stroke-width="128" stroke-dasharray="9 calc(3.14 * 128)" transform="rotate(86 70 6)"></circle>' +
                                '</g>' +
                                '<path class="btn_x_border"      d="M 6 6 a 64 64 90 0 0 128 0 z" stroke="#000" fill="transparent"></path>' +
                                '<text class="btn_text chord_text" x="70" y="82" text-anchor="middle">0.000%</text>' +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        ctrl.find('.btn_text').text(controlData.AnalogStage1.toFixed(3).padStart(6, ' ') + '%');
                        if (Math.abs(controlData.AnalogStage1) < 0.01) {
                            //ctrl.find('.btn_x_data3').attr('transform', 'rotate(80 70 6)');
                            ctrl.find('.btn_x_data3').attr('transform', 'rotate(86 70 6)');
                            //ctrl.find('.btn_x_data2').attr('transform', 'rotate(83 70 6)');
                            ctrl.find('.btn_x_data2').attr('transform', 'rotate(86 70 6)');
                            ctrl.find('.btn_x_data').attr('transform', 'rotate(86 70 6)');
                        } else {
                            //ctrl.find('.btn_x_data3').show().attr('transform', 'rotate(' + (80 + controlData.AnalogStage1 * -84) + ' 70 6)');
                            ctrl.find('.btn_x_data3').show().attr('transform', 'rotate(' + (86 + controlData.AnalogStage1 * -80) + ' 70 6)');
                            //ctrl.find('.btn_x_data2').show().attr('transform', 'rotate(' + (83 + controlData.AnalogStage1 * -87) + ' 70 6)');
                            ctrl.find('.btn_x_data2').show().attr('transform', 'rotate(' + (86 + controlData.AnalogStage1 * -85) + ' 70 6)');
                            ctrl.find('.btn_x_data').show().attr('transform', 'rotate(' + (86 + controlData.AnalogStage1 * -90) + ' 70 6)');
                        }
                    }
                    break;

                case 'ExtendInput.Controls.ControlDualStrikePivot':
                case 'ExtendInput.Controls.IControlDualStrikePivot':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                //'<svg id="control_render_' + controller_id + '__' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="182" height="182" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                '<path class="btn_n" d="M 091,031 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(180 091 031) translate(-30,-30)"></path>' +
                                '<path class="btn_e" d="M 151,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(-90 151 091) translate(-30,-30)"></path>' +
                                '<path class="btn_s" d="M 091,151 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(0 091 151) translate(-30,-30)"></path>' +
                                '<path class="btn_w" d="M 031,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(90 031 091) translate(-30,-30)"></path>' +
                                '</g>' +
                                '<g transform="translate(21,21)">' +
                                //'<path class="stick_click" d="M 2,2 m 0,136 136,0 0,-136 -136,0 z" stroke="#999" fill="none" stroke-width="3"></path>' +
                                '<path class="" d="M 6,6 m 0,128 128,0 0,-128 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                '<ellipse class="" ry="64" rx="64" cy="70" cx="70" stroke="#000" fill="#fff" />' +
                                '<g class="stick_float" cy="70" cx="70">' +
                                '<ellipse ry="2" rx="2" cy="0" cx="0" fill="#000" />' +
                                '<text class="chord_text stick_float_text" x="-4" y="4" transform="translate(5,-5)"></text>' +
                                '</g>' +
                                '</g>' +
                                '</svg>');;
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        var stickFloat = ctrl.find('.stick_float');
                        stickFloat.attr('transform', 'translate(' + (70 + controlData.X * 63) + ',' + (70 + controlData.Y * 63) + ')');
                        stickFloat.children('.stick_float_text').attr('transform', 'translate(' + (controlData.X > 0 ? 0 : 6) + ',' + (controlData.Y > 0 ? -6 : 6) + ')').attr('text-anchor', (controlData.X > 0 ? "end" : "initial")).text(cord_formatter.format(controlData.X) + ',' + cord_formatter.format(controlData.Y));
                        if (controlData.XMin) { ctrl.find('.btn_w').addClass('active'); } else { ctrl.find('.btn_w').removeClass('active'); }
                        if (controlData.XMax) { ctrl.find('.btn_e').addClass('active'); } else { ctrl.find('.btn_e').removeClass('active'); }
                        if (controlData.YMin) { ctrl.find('.btn_n').addClass('active'); } else { ctrl.find('.btn_n').removeClass('active'); }
                        if (controlData.YMax) { ctrl.find('.btn_s').addClass('active'); } else { ctrl.find('.btn_s').removeClass('active'); }
                    }
                    break;

                case 'ExtendInput.Controls.ControlStick':
                case 'ExtendInput.Controls.IControlStick':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                //'<path class="stick_click" d="M 2,2 m 0,136 136,0 0,-136 -136,0 z" stroke="#999" fill="none" stroke-width="3"></path>' +
                                '<path class="" d="M 6,6 m 0,128 128,0 0,-128 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                '<ellipse class="" ry="64" rx="64" cy="70" cx="70" stroke="#000" fill="#fff" />' +
                                '<g class="stick_float" cy="70" cx="70">' +
                                '<ellipse ry="2" rx="2" cy="0" cx="0" fill="#000" />' +
                                '<text class="chord_text stick_float_text" x="-4" y="4" transform="translate(5,-5)"></text>' +
                                '</g>' +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        var stickFloat = ctrl.find('.stick_float');
                        stickFloat.attr('transform', 'translate(' + (70 + controlData.X * 63) + ',' + (70 + controlData.Y * 63) + ')');
                        stickFloat.children('.stick_float_text').attr('transform', 'translate(' + (controlData.X > 0 ? 0 : 6) + ',' + (controlData.Y > 0 ? -6 : 6) + ')').attr('text-anchor', (controlData.X > 0 ? "end" : "initial")).text(cord_formatter.format(controlData.X) + ',' + cord_formatter.format(controlData.Y));
                    }
                    break;
                case 'ExtendInput.Controls.ControlStickWithClick':
                case 'ExtendInput.Controls.IControlStickWithClick':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +
                                '<path class="stick_click" d="M 2,2 m 0,136 136,0 0,-136 -136,0 z" stroke="#999" fill="none" stroke-width="3"></path>' +
                                '<path class="" d="M 6,6 m 0,128 128,0 0,-128 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                '<ellipse class="" ry="64" rx="64" cy="70" cx="70" stroke="#000" fill="#fff" />' +
                                '<g class="stick_float" cy="70" cx="70">' +
                                '<ellipse ry="2" rx="2" cy="0" cx="0" fill="#000" />' +
                                '<text class="chord_text stick_float_text" x="-4" y="4" transform="translate(5,-5)"></text>' +
                                '</g>' +
                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        var stickFloat = ctrl.find('.stick_float');
                        stickFloat.attr('transform', 'translate(' + (70 + controlData.X * 63) + ',' + (70 + controlData.Y * 63) + ')');
                        stickFloat.children('.stick_float_text').attr('transform', 'translate(' + (controlData.X > 0 ? 0 : 6) + ',' + (controlData.Y > 0 ? -6 : 6) + ')').attr('text-anchor', (controlData.X > 0 ? "end" : "initial")).text(cord_formatter.format(controlData.X) + ',' + cord_formatter.format(controlData.Y));
                        if (controlData.Click) ctrl.find('.stick_click').addClass('active-o'); else ctrl.find('.stick_click').removeClass('active-o');
                    }
                    break;
                case 'ExtendInput.Controls.ControlTouch':
                case 'ExtendInput.Controls.IControlTouch':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        var ratioW = 1;
                        var ratioH = 1;
                        if (controlData.PhysicalWidth > controlData.PhysicalHeight) {
                            ratioH = controlData.PhysicalHeight / controlData.PhysicalWidth;
                        } else {
                            ratioW = controlData.PhysicalWidth / controlData.PhysicalHeight;
                        }
                        if (!isFinite(ratioW) || !isFinite(ratioH)) {
                            ratioW = 1;
                            ratioH = 1;
                        }
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            var domString =
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                '<g transform="translate(' + (((1 - ratioW) / 2) * 130) + ',' + (((1 - ratioH) / 2) * 130) + ')">' +
                                '<path class="pad_click" d="M 2,2 m 0,' + (128 * ratioH + 8) + ' ' + (128 * ratioW + 8) + ',0 0,-' + (128 * ratioH + 8) + ' -' + (128 * ratioW + 8) + ',0 z" stroke="#999" fill="none" stroke-width="3"></path>' +
                                '<path class="" d="M 6,6 m 0,' + (128 * ratioH) + ' ' + (128 * ratioW) + ',0 0,-' + (128 * ratioH) + ' -' + (128 * ratioW) + ',0 z" stroke="#000" fill="#fff"></path>';
                            //'<ellipse class="" ry="64" rx="64" cy="70" cx="70" stroke="#000" fill="#fff" />' +
                            for (var i = 0; i < controlData.Touch.length; i++) {
                                domString +=
                                    '<g cy="70" cx="70" class="pad_float_' + i + '" style="display: none;">' +
                                    '<ellipse ry="2" rx="2" cy="0" cx="0" fill="#000" />' +
                                    '<text class="chord_text pad_float_text" x="-4" y="4" transform="translate(5,-5)">' +
                                    '<tspan x="0", dy="0em">' + i + '</tspan>' +
                                    '<tspan x="0", dy="1em"> 0.00, 0.00</tspan>' +
                                    '</text>' +
                                    '</g>';
                            }
                            domString +=
                                '</g>' +
                                '</svg>';
                            renderElement.empty().append(domString);
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        for (var i = 0; i < controlData.Touch.length; i++) {
                            var stickFloat = ctrl.find('.pad_float_' + i);
                            if (controlData.Touch[i]) {
                                stickFloat.attr('transform', 'translate(' + (6 + (64 + controlData.X[i] * 63) * ratioW) + ',' + (6 + (64 + controlData.Y[i] * 63) * ratioH) + ')');
                                stickFloat.children('.pad_float_text').attr('transform', 'translate(' + (controlData.X[i] > 0 ? -6 : 6) + ',' + (controlData.Y[i] > 0 ? -6 : 6) + ')').attr('text-anchor', (controlData.X[i] > 0 ? "end" : "initial"));
                                stickFloat.children('.pad_float_text').children('tspan:first()').text(i);
                                stickFloat.children('.pad_float_text').children('tspan:last()').text(cord_formatter.format(controlData.X[i]) + ',' + cord_formatter.format(controlData.Y[i])).attr("dy", controlData.Y[i] > 0 ? "-1em" : "1em");
                                stickFloat.show();
                            } else {
                                stickFloat.hide();
                            }
                        }
                        if (controlData.HasClick) if (controlData.Click) ctrl.find('.pad_click').addClass('active-o'); else ctrl.find('.pad_click').removeClass('active-o', 'disable-o'); else ctrl.find('.pad_click').addClass('disable-o');
                    }
                    break;
                case 'ExtendInput.Controls.ControlButtonGrid':
                case 'ExtendInput.Controls.IControlButtonGrid':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            var domString =
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>';
                            for (var x = 0; x < controlData.Button.length; x++) {
                                for (var y = 0; y < controlData.Button[0].length; y++) {
                                    var sizeX = 136 / controlData.Button.length;
                                    var sizeY = 136 / controlData.Button[0].length;
                                    domString += '<path class="btn_' + x + '_' + y + '" d="M ' + (1 + sizeX * x) + ',' + (1 + sizeY * y) + ' m 0,' + sizeY + ' ' + sizeX + ',0 0,-' + sizeY + ' -' + sizeX + ',0 z" stroke="#999" fill="none" stroke-width="2"></path>';
                                }
                            }
                            domString +=
                                '</g>' +
                                '</svg>'
                            renderElement.empty().append(domString);
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        '<g>';
                        for (var x = 0; x < controlData.Button.length; x++) {
                            for (var y = 0; y < controlData.Button[0].length; y++) {
                                if (controlData.Button[x][y]) ctrl.find('.btn_' + x + '_' + y).addClass('active'); else ctrl.find('.btn_' + x + '_' + y).removeClass('active');
                            }
                        }
                        //var stickFloat = ctrl.find('.stick_float');
                        //stickFloat.attr('cx', 70 + controlData.X * 63);
                        //stickFloat.attr('cy', 70 + controlData.Y * 63);
                        //if (controlData.HasClick) if (controlData.Click) ctrl.find('.stick_click').addClass('active-o'); else ctrl.find('.stick_click').removeClass('active-o', 'disable-o'); else ctrl.find('.stick_click').addClass('disable-o');
                    }
                    break;

                case 'ExtendInput.Controls.ControlEccentricRotatingMass':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="76" height="86" xmlns="http://www.w3.org/2000/svg">' +
                                '<g transform="translate(38,38)">' +
                                '<path class="spin" class="btn_x_border" d="M 7.04 0 l 21.12 0 a 28.16 28.16 90 0 1 -56.32 0 h 21.12 a 0.44 0.44 90 0 1 14.08 0 z" stroke="#000" fill="' + (controlData.IsHeavy ? 'black' : 'transparent') + '"></path>' +
                                '</g>' +
                                '<text class="btn_text chord_text" x="38" y="82" text-anchor="middle">0.000%</text>' +
                                '</svg>');
                            var inputsWrapperElement = $('<div class="form-group" id="control_property_list_' + controller_id + '__' + control_id + '"/>');
                            inputsWrapperElement.append('<label class="small mb-0">Power</label\>');
                            inputsWrapperElement.append('<input type="range" data-property="Power" class="control_property_item form-control-range" value="' + controlData.Power + '" min="0" max="1" step="0.001" \>');
                            renderElement.append(inputsWrapperElement);
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        if (controlData.Power == 0) {
                            ctrl.find('.spin').css("animation-duration", "unset");
                            var OldSpin = ctrl.find('.spin').data("power");
                            if (OldSpin != 0 && OldSpin != controlData.Power) {
                                ctrl.find('.spin').attr("transform", "rotate(" + (Math.random() * 360) + ")");
                            }
                        } else {
                            ctrl.find('.spin').css("animation-duration", (1 - controlData.Power * 0.99) + "s");
                        }
                        ctrl.find('.spin').data("power", controlData.Power);
                        ctrl.find('.btn_text').text(controlData.Power.toFixed(3).padStart(6, ' ') + '%');
                    }
                    break;

                case 'ExtendInput.Controls.ControlSpinnerRelative':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="76" height="86" xmlns="http://www.w3.org/2000/svg">' +
                                '<g transform="translate(38,38)">' +
                                '<path class="spinner" class="btn_x_border" d="M 20 0 L 28 1 A 28 28 0 0 1 3 28 L 1 20 L -1 20 L -3 28 A 28 28 0 0 1 -28 1 L -20 0 L -28 -1 A 28 28 0 0 1 -1 -28 L 0 -20 L 1 -28 A 28 28 0 0 1 28 -1 z" stroke="#000" fill="transparent"></path>' +
                                '</g>' +
                                '</svg>');
                            var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                            ctrl.find('.spinner').data("rotation", 0);
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        var NewSpin = ctrl.find('.spinner').data("rotation") + controlData.Delta * 360 / controlData.Divisions;
                        ctrl.find('.spinner').data("rotation", NewSpin);
                        ctrl.find('.spinner').css("transform", "rotate(" + NewSpin + "deg)");
                    }
                    break;
                case 'ExtendInput.Controls.ControlScrollWheelRelative':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('div.wheel_parent').length == 0) {
                            var wheel_height = 92;
                            var items = 24 / 2;
                            var diameter = wheel_height;
                            var radius = diameter / 2;
                            var angle = 360 / items;
                            var circumference = Math.PI * diameter;
                            var height = circumference / items;
                            var controlHtml =
                                '<div class="wheel_parent" id="control_render_' + controller_id + '__' + control_id + '" width="76" height="86">' +
                                '<div class="wheel_click" style="padding:2px;margin:0 auto;width: 40px;">' +
                                '<div class="wheel">' +
                                //`<div class="wheel__inner" style="transform-origin: 50% calc(50% + ${height / 2}px); margin-top: -${height / 2}px">`;
                                `<div class="wheel__inner" style="transform-origin: 50% calc(50% + ${height / 2}px); margin-top: -${height / 2}px">`;
                            for (let i = 0; i < items; i++) {
                                var transform = `rotateX(${angle * i}deg) translateZ(${radius}px)`;
                                controlHtml += '<div class="wheel__segment" style="transform:' + transform + '; height:' + height + 'px;"><span></span></div>';
                            }
                            controlHtml += '</div>' +
                                '</div>' +
                                '</div>' +
                                '</div>';
                            renderElement.empty().append(controlHtml);
                            var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                            ctrl.find('.wheel__inner').data("rotation", 0);
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        var NewSpin = ctrl.find('.wheel__inner').data("rotation") - controlData.Delta * 360 / controlData.Divisions;
                        ctrl.find('.wheel__inner').data("rotation", NewSpin);
                        ctrl.find('.wheel__inner').css("transform", "rotateX(" + NewSpin + "deg)");
                        if (controlData.HasClick) if (controlData.Click) ctrl.find('.wheel_click').addClass('active-o'); else ctrl.find('.wheel_click').removeClass('active-o', 'disable-o'); else ctrl.find('.wheel_click').addClass('disable-o');
                    }
                    break;

                case 'ExtendInput.Controls.ControlMotion':
                    {
                        /*
  "AccelerometerX": 0,
  "AccelerometerY": 0,
  "AccelerometerZ": 0,
  "AngularVelocityX": 35,
  "AngularVelocityY": -6,
  "AngularVelocityZ": -9,
  "OrientationW": 0,
  "OrientationX": 0,
  "OrientationY": 0,
  "OrientationZ": 0,
  "DataStuck": false,
  "IsWriteDirty": false,
  "IsReadDirty": false
  //32767
  //-32768
*/
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="140" height="' + (38 + 35 * 5) + '" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +

                                '<g transform="translate(0,' + (35 * 0) + ')">' +
                                '<path class="btn_AccelerometerX"      d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                '<path class="btn_AccelerometerX_data" d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#333"></path>' +
                                '<text class="btn_AccelerometerX_text chord_text" x="70" y="34" text-anchor="middle">0.000%</text>' +
                                '</g>' +

                                '<g transform="translate(0,' + (35 * 1) + ')">' +
                                '<path class="btn_AccelerometerY"      d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                '<path class="btn_AccelerometerY_data" d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#333"></path>' +
                                '<text class="btn_AccelerometerY_text chord_text" x="70" y="34" text-anchor="middle">0.000%</text>' +
                                '</g>' +

                                '<g transform="translate(0,' + (35 * 2) + ')">' +
                                '<path class="btn_AccelerometerZ"      d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                '<path class="btn_AccelerometerZ_data" d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#333"></path>' +
                                '<text class="btn_AccelerometerZ_text chord_text" x="70" y="34" text-anchor="middle">0.000%</text>' +
                                '</g>' +

                                '<g transform="translate(0,' + (35 * 3) + ')">' +
                                '<path class="btn_AngularVelocityX"      d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                '<path class="btn_AngularVelocityX_data" d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#333"></path>' +
                                '<text class="btn_AngularVelocityX_text chord_text" x="70" y="34" text-anchor="middle">0.000%</text>' +
                                '</g>' +

                                '<g transform="translate(0,' + (35 * 4) + ')">' +
                                '<path class="btn_AngularVelocityY"      d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                '<path class="btn_AngularVelocityY_data" d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#333"></path>' +
                                '<text class="btn_AngularVelocityY_text chord_text" x="70" y="34" text-anchor="middle">0.000%</text>' +
                                '</g>' +

                                '<g transform="translate(0,' + (35 * 5) + ')">' +
                                '<path class="btn_AngularVelocityZ"      d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                '<path class="btn_AngularVelocityZ_data" d="M 6,6 m 0,16 128,0 0,-16 -128,0 z" stroke="#000" fill="#333"></path>' +
                                '<text class="btn_AngularVelocityZ_text chord_text" x="70" y="34" text-anchor="middle">0.000%</text>' +
                                '</g>' +

                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);

                        ctrl.find('.btn_AccelerometerX_text').text((controlData.AccelerometerX * 100 / 32768).toFixed(3) + '%');
                        ctrl.find('.btn_AccelerometerX_data').css('clip-path', 'inset(0 ' + ((controlData.AccelerometerX + 32768) * 100 / 32768 / 2) + '% 0 0)');

                        ctrl.find('.btn_AccelerometerY_text').text((controlData.AccelerometerY * 100 / 32768).toFixed(3) + '%');
                        ctrl.find('.btn_AccelerometerY_data').css('clip-path', 'inset(0 ' + ((controlData.AccelerometerY + 32768) * 100 / 32768 / 2) + '% 0 0)');

                        ctrl.find('.btn_AccelerometerZ_text').text((controlData.AccelerometerZ * 100 / 32768).toFixed(3) + '%');
                        ctrl.find('.btn_AccelerometerZ_data').css('clip-path', 'inset(0 ' + ((controlData.AccelerometerZ + 32768) * 100 / 32768 / 2) + '% 0 0)');

                        ctrl.find('.btn_AngularVelocityX_text').text((controlData.AngularVelocityX * 100 / 32768).toFixed(3) + '%');
                        ctrl.find('.btn_AngularVelocityX_data').css('clip-path', 'inset(0 ' + ((controlData.AngularVelocityX + 32768) * 100 / 32768 / 2) + '% 0 0)');

                        ctrl.find('.btn_AngularVelocityY_text').text((controlData.AngularVelocityY * 100 / 32768).toFixed(3) + '%');
                        ctrl.find('.btn_AngularVelocityY_data').css('clip-path', 'inset(0 ' + ((controlData.AngularVelocityY + 32768) * 100 / 32768 / 2) + '% 0 0)');

                        ctrl.find('.btn_AngularVelocityZ_text').text((controlData.AngularVelocityZ * 100 / 32768).toFixed(3) + '%');
                        ctrl.find('.btn_AngularVelocityZ_data').css('clip-path', 'inset(0 ' + ((controlData.AngularVelocityZ + 32768) * 100 / 32768 / 2) + '% 0 0)');
                    }
                    break;

                /*case 'ExtendInput.Controls.ControlButtonPair':
                    //case 'ExtendInput.Controls.ControlTriggerPair':
                    {
                        var renderElement = wrapper.find('.control-value');
                        renderElement.addClass('text-center');
                        if (NewSubtype || renderElement.children('svg').length == 0) {
                            renderElement.empty().append(
                                '<svg id="control_render_' + controller_id + '__' + control_id + '" width="182" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                '<g>' +

                                //'<ellipse class="btn_l_click" ry="29" rx="29" cy="31" cx="031" stroke="#ccc" fill="none" stroke-width="3" />' +
                                //'<ellipse class="" ry="25" rx="25" cy="31" cx="031" stroke="#000" fill="#fff" />' +
                                //'<ellipse class="btn_l_data" ry="0" rx="0" cy="31" cx="031" stroke="#000" fill="#333" />' +
                                DrawButtonSvg("btn_l", 31, 31) +

                                //'<ellipse class="btn_r_click" ry="29" rx="29" cy="31" cx="151" stroke="#ccc" fill="none" stroke-width="3" />' +
                                //'<ellipse class="" ry="25" rx="25" cy="31" cx="151" stroke="#000" fill="#fff" />' +
                                //'<ellipse class="btn_r_data" ry="0" rx="0" cy="31" cx="151" stroke="#000" fill="#333" />' +
                                DrawButtonSvg("btn_r", 151, 31) +

                                '</g>' +
                                '</svg>');
                        }
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        if (controlData.Left.Button0) {
                            ctrl.find('.btn_l_data').attr('rx', 25).attr('ry', 25);
                        } else {
                            ctrl.find('.btn_l_data').attr('rx', controlData.Left.Analog * 25).attr('ry', controlData.Left.Analog * 25);
                        }
                        if (controlData.Right.Button0) {
                            ctrl.find('.btn_r_data').attr('rx', 25).attr('ry', 25);
                        } else {
                            ctrl.find('.btn_r_data').attr('rx', controlData.Right.Analog * 25).attr('ry', controlData.Right.Analog * 25);
                        }
                        if (controlData.Left.HasStage2 == "Digital") if (controlData.Left.Stage2) ctrl.find('.btn_l_click').addClass('active-o'); else ctrl.find('.btn_l_click').removeClass('active-o', 'disable-o'); else ctrl.find('.btn_l_click').addClass('disable-o');
                        if (controlData.Right.HasStage2 == "Digital") if (controlData.Right.Stage2) ctrl.find('.btn_r_click').addClass('active-o'); else ctrl.find('.btn_r_click').removeClass('active-o', 'disable-o'); else ctrl.find('.btn_r_click').addClass('disable-o');
                    }
                    break;
                case 'ExtendInput.Controls.ControlPair':
                    {
                        var renderElement = wrapper.find('.control-value');
                        //renderElement.addClass('text-center');
                        var ctrl = renderElement.find('#control_render_' + controller_id + '__' + control_id);
                        if (controlData.Button0) ctrl.find('.btn_x').addClass('active'); else ctrl.find('.btn_x').removeClass('active');

                        RenderControl(controller_id + '__' + control_id + "-Left", controlData.Left, controlType.split('[')[1].split(']')[0], renderElement, NewSubtype, knownChildren, true);
                        RenderControl(controller_id + '__' + control_id + "-Right", controlData.Right, controlType.split('[')[1].split(']')[0], renderElement, NewSubtype, knownChildren, true);

                        //RenderControl(controller_id + '__' + control_id + "-Left", controlData.Left, controlType.split('[')[1].split(']')[0], $state_data, NewSubtype, knownChildren);
                        //RenderControl(controller_id + '__' + control_id + "-Right", controlData.Right, controlType.split('[')[1].split(']')[0], $state_data, NewSubtype, knownChildren);
                    }
                    break;*/
                //case 'ExtendInput.Controls.ControlMotion':
                //    {
                //        var renderElement = wrapper.find('.control-value');
                //        if (NewSubtype || renderElement.children('div.model').length == 0) {
                //            renderElement.empty().append('<div class="model"/>');
                //            var container = renderElement.children('div.model')[0];
                //            var renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                //            renderer.setSize(container.clientWidth, container.clientHeight);
                //            container.innerHTML = '';
                //            container.appendChild(renderer.domElement);
                //            renderer.setClearColor(0xFFFFFF, 0);
                //            renderer.clear();
                //            window.camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
                //            //camera.position.x = -1; camera.position.y = 1; camera.position.z = -1;
                //            camera.position.z = 1;
                //            /*var cameraControls;
                //            cameraControls = new THREE.OrbitControls(camera, renderer.domElement);
                //            cameraControls.target.set(0, 0, 0);
                //            cameraControls.maxDistance = 0.5;
                //            cameraControls.minDistance = 0.3;
                //            cameraControls.update();*/

                //            var scene = new THREE.Scene();

                //            var ambientLight = new THREE.AmbientLight(0x888888);
                //            scene.add(ambientLight);

                //            var light = new THREE.SpotLight();
                //            light.castShadow = true;
                //            light.position.set(170, 330, -160);
                //            scene.add(light);

                //            var loader = new THREE.ColladaLoader();
                //            loader.load("./3d/model.dae", function (geometry, materials) {
                //                //geometry.scene = geometry.scene.translateZ(-0.5);
                //                scene.add(geometry.scene);
                //                model_bz1 = geometry.scene;
                //                model_bz1.visible = true;
                //            });

                //            scene.add(camera);
                //            pointLight = new THREE.PointLight(0x888888);
                //            pointLight.position.set(1, 1, 2);
                //            camera.add(pointLight);

                //            renderer.render(scene, camera);

                //            $(container).data('render', renderer);

                //            setTimeout(onWindowResize, 100);

                //            function update() {
                //                requestAnimationFrame(update);
                //                //cameraControls.update();
                //                renderer.render(scene, camera);
                //            }

                //            update();
                //        }
                //    }
                //    break;
                default:
                    wrapper.find('.control-value').addClass('text-monospace small').text(JSON.stringify(controlData, null, 2));
                    break;
            }

            if (existing.length == 0) {
                $state_data.append(wrapper);
            }
        }

        function onWindowResize(event) {
            $('div.model').each(function (idx, elem) {

                SCREEN_WIDTH = elem.clientWidth;
                SCREEN_HEIGHT = elem.clientHeight;

                var renderer = $(elem).data('render');

                renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);

                camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
                camera.updateProjectionMatrix();
            });
        }

        window.addEventListener('resize', onWindowResize, false);

        function SocketStartup() {
            socket = new WebSocket("ws://" + location.host + "/socket");
            //socket.addEventListener('open', function (event) {
            //    socket.send('Hello Server!');
            //});

            // Listen for messages
            socket.addEventListener('message', function (event) {
                var eventData = JSON.parse(event.data)
                switch (eventData.function) {
                    case "DeviceManager:StartupData":
                        console.log("DeviceManager:StartupData ", eventData.data);
                        StartupData(eventData.data);
                        break;
                    case "DeviceManager:ControllerAdded":
                        console.log("DeviceManager:ControllerAdded ", eventData.data);
                        AddController(eventData.data);
                        break;
                    case "DeviceManager:ControllerMetadataUpdate":
                        console.log("DeviceManager:ControllerMetadataUpdate ", eventData.data);
                        AddController(eventData.data);
                        break;
                    case "DeviceManager:ControllerRemoved":
                        console.log("DeviceManager:ControllerRemoved ", eventData.data);
                        RemoveController(eventData.data);
                        break;
                    case "DeviceManager:ActiveControllers":
                        console.log("DeviceManager:ActiveControllers ", eventData.data);
                        ControllersActive(eventData.data);
                        break;
                    case "DeviceManager:ControllerState":
                        //console.log("DeviceManager:ControllerState ", eventData.data);
                        ControllerStateUpdate(eventData.data);
                        break;
                    default:
                        console.log('Unknown message from server ', eventData);
                        break;
                }
            });

            //socket.onopen = function (event) {
            //    socket.send("Here's some text that the server is urgently awaiting!");
            //    //exampleSocket.send(JSON.stringify({ test: true }));
            //};
        }

        function ControllersActive(data) {
            var knownChildren = {};
            $controllers.children().each((i, elem) => knownChildren[elem.id] = true);
            var knownStateChildren = {};
            var $state_data = $('#state_data');
            $state_data.children().each((i, elem) => knownStateChildren[$(elem).data('controller-id')] = true);
            data.forEach((val, idx) => {
                var controller_id = cyrb53(val);
                knownChildren['controller_' + controller_id] = false;
                knownStateChildren[controller_id] = false;
                $('#controller_' + controller_id).addClass('controller-active');
            });
            for (const key in knownChildren) {
                if (knownChildren[key]) {
                    $('#' + key).removeClass('controller-active');
                }
            }
            for (const key in knownStateChildren) {
                if (knownStateChildren[key]) {
                    $state_data.children('[data-controller-id="' + key + '"]').remove();
                }
            }
        }

        function ControllerStateUpdate(data) {
            var $state_data = $('#state_data');
            var knownChildren = {};
            $state_data.children().each((i, elem) => knownChildren[elem.id] = true);
            var NewSubtype = (ControllerActiveSubtype != data.ControllerTypeCode);
            ControllerActiveSubtype = data.ControllerTypeCode;
            var controller_id = cyrb53(data.ConnectionUniqueID);
            for (const control_id in data.State) {
                RenderControl(data.ConnectionUniqueID, controller_id, control_id, data.State[control_id].Data, data.State[control_id].Type, $state_data, NewSubtype, knownChildren);
            }
            for (const control_id in knownChildren) {
                $state_data.children('#' + controller_id + '__' + control_id).remove();
            }
        }

        function StartupData(data) {

            ControllerImages = data.ControllerImages;
            IconImages = data.IconImages;

            // manual controller types
            var existing_manual = {};
            $('#manual').children().each(function (idx, elem) { existing_manual[$(elem).data('id')] = elem; });
            for (const device_id in data.ManualDevices) {
                var manualDevice = data.ManualDevices[device_id];
                if (existing_manual[device_id] != null) {
                    delete existing_manual[device_id];
                } else {
                    var elem = $('<a href="#" class="list-group-item list-group-item-action" />');
                    elem.attr('data-id', device_id);
                    elem.text(manualDevice);
                    $('#manual').append(elem);
                }
            }
            for (var manual_elem_key in existing_manual) {
                $(existing_manual[manual_elem_key]).remove();
            }
        }

        function RemoveController(controller) {
            var controller_id = cyrb53(controller);
            var existing = $controllers.children('#controller_' + controller_id);
            existing.remove();
            // deactivate the controller if it's active
        }

        function AddController(controller) {
            var knownChildren = {};
            $controllers.children().each((i, elem) => knownChildren[elem.id] = true);
            //for (const controller_id in data.Controllers)
            {
                //var controller = data.Controllers[controller_id];

                var controller_id = cyrb53(controller.ConnectionUniqueID);

                var ConnectionIcon = null;
                for (var idx in controller.ConnectionTypeCode) {
                    var code = controller.ConnectionTypeCode[idx];
                    if (IconImages[code] != null) {
                        ConnectionIcon = IconImages[code];
                        break;
                    }
                }

                var ControllerIcon = null;
                var ControllerImage = null;
                for (var idx in controller.ControllerTypeCode) {
                    var code = controller.ControllerTypeCode[idx];
                    if (ControllerIcon == null && IconImages[code] != null) {
                        ControllerIcon = IconImages[code];
                    }
                    if (ControllerImage == null && ControllerImages[code] != null) {
                        ControllerImage = ControllerImages[code];
                    }
                    if (ControllerIcon != null && ControllerImage != null)
                        break;
                }

                var existing = $controllers.children('#controller_' + controller_id);
                if (existing.length == 0) {
                    //var wrapper = $('<div class="controller col-md-6 col-lg-4 pb-4"/>');
                    var wrapper = $('<div class="controller col-12 pb-4"/>');
                    wrapper.attr('id', 'controller_' + controller_id);
                    var cardWrapper = $('<div class="card" />');
                    if (ControllerImage != null) {
                        var cardImage = $('<img class="controller_image" />');
                        cardImage.attr("src", "/images/controller/" + ControllerImage);
                        cardImage.attr("alt", controller.Name);
                        cardWrapper.append(cardImage);
                    } else {
                        var cardImage = $('<img class="controller_image" />');
                        cardImage.attr("src", "/images/controller/placeholder.png");
                        cardImage.attr("alt", controller.Name);
                        cardWrapper.append(cardImage);
                    }

                    cardWrapper.append('<div class="card-body"><h5 class="card-title"><img class="connection_icon" /><img class="controller_icon" /><span class="controller_name"></span></h5><p class="card-text controller_name_details" style="white-space:pre;"></p><p class="card-text controller_connection_unique_id"></p><p class="card-text controller_device_unique_id"></p><pre><code class="card-text controller_device_properties"></code></pre></div>');

                    if (ControllerIcon != null) {
                        var cardImage = cardWrapper.find('.controller_icon');
                        cardImage.attr("src", "/images/icon/" + ControllerIcon);
                        cardImage.attr("alt", controller.Name);
                    } else {
                        var cardImage = cardWrapper.find('.controller_icon');
                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                        cardImage.attr("alt", controller.Name);
                    }
                    if (ConnectionIcon != null) {
                        var cardImage = cardWrapper.find('.connection_icon');
                        cardImage.attr("src", "/images/icon/" + ConnectionIcon);
                        cardImage.attr("alt", controller.Name);
                    } else {
                        var cardImage = cardWrapper.find('.connection_icon');
                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                        cardImage.attr("alt", controller.Name);
                    }

                    var menu = $('<div class="list-group small alternate_controller_list" />');
                    menu.append('<h6 class="list-group-item">Alternate Controllers</h6>');

                    //if (controller.HasSelectableAlternatives) {
                    {
                        for (var alternate in controller.Alternates) {
                            var alternate_item = $('<a class="alternate_controller list-group-item list-group-item-action" href="#" />');
                            alternate_item.attr('data-id', alternate);
                            alternate_item.text(controller.Alternates[alternate]);
                            menu.append(alternate_item);
                        }
                        var alternateBody = $('<div class="card-body" />');
                        alternateBody.append(menu);
                        cardWrapper.append(alternateBody);

                        if (controller.HasSelectableAlternatives) {
                            alternateBody.show();
                        } else {
                            alternateBody.hide();
                        }
                    }

                    var controllerActivateButton = $('<a href="#" class="btn btn-primary btn-lg btn-block activate_controller" role="button"></a>');
                    controllerActivateButton.attr('data-id', controller.ConnectionUniqueID);
                    cardWrapper.append(controllerActivateButton);
                    wrapper.append(cardWrapper);
                } else {
                    wrapper = existing;
                    delete knownChildren['controller_' + controller_id];

                    var menu = wrapper.find('.alternate_controller_list');
                    if (controller.HasSelectableAlternatives) {
                        menu.parent().show();
                    } else {
                        menu.parent().hide();
                    }
                    for (var alternate in controller.Alternates) {
                        if (menu.children('.alternate_controller[data-id="' + alternate + '"]').length == 0) {
                            var alternate_item = $('<a class="alternate_controller list-group-item list-group-item-action" href="#" />');
                            alternate_item.attr('data-id', alternate);
                            alternate_item.text(controller.Alternates[alternate]);
                            menu.append(alternate_item);
                        }
                    }

                    if (ControllerImage != null) {
                        var cardImage = wrapper.find('.controller_image');
                        cardImage.attr("src", "/images/controller/" + ControllerImage);
                        cardImage.attr("alt", controller.Name);
                    } else {
                        var cardImage = wrapper.find('.controller_image');
                        cardImage.attr("src", "/images/controller/placeholder.png");
                        cardImage.attr("alt", controller.Name);
                    }

                    if (ControllerIcon != null) {
                        var cardImage = wrapper.find('.controller_icon');
                        cardImage.attr("src", "/images/icon/" + ControllerIcon);
                        cardImage.attr("alt", controller.Name);
                    } else {
                        var cardImage = wrapper.find('.controller_icon');
                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                        cardImage.attr("alt", controller.Name);
                    }
                    if (ConnectionIcon != null) {
                        var cardImage = wrapper.find('.connection_icon');
                        cardImage.attr("src", "/images/icon/" + ConnectionIcon);
                        cardImage.attr("alt", controller.Name);
                    } else {
                        var cardImage = wrapper.find('.connection_icon');
                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                        cardImage.attr("alt", controller.Name);
                    }
                }

                var knownAlternates = {};
                var alternate_controller_list_dom = wrapper.find('.alternate_controller_list');
                alternate_controller_list_dom.children('.alternate_controller').each((i, elem) => knownAlternates[$(elem).data('id')] = true);
                for (const alternate in knownAlternates) {
                    if (!controller.Alternates[alternate])
                        alternate_controller_list_dom.children('.alternate_controller[data-id="' + alternate + '"]').remove();
                }


                wrapper.find('.controller_name').text(controller.Name);
                if (controller.NameDetails != null) {
                    wrapper.find('.controller_name_details').text(controller.NameDetails.join('\r\n'));
                } else {
                    wrapper.find('.controller_name_details').text('');
                }
                if (controller.ConnectionUniqueID != null) {
                    wrapper.find('.controller_connection_unique_id').text("Connection:\r\n" + controller.ConnectionUniqueID);
                } else {
                    wrapper.find('.controller_connection_unique_id').text('');
                }
                if (controller.DeviceUniqueID != null) {
                    wrapper.find('.controller_device_unique_id').text("Device:\r\n" + controller.DeviceUniqueID);
                } else {
                    wrapper.find('.controller_device_unique_id').text('');
                }
                if (controller.DeviceUniqueID != null) {
                    wrapper.find('.controller_device_properties').text(JSON.stringify(controller.DeviceProperties, null, 2));
                } else {
                    wrapper.find('.controller_device_properties').text('');
                }

                if (existing.length == 0) {
                    $controllers.append(wrapper);
                }
            }
            //for (const controller_id in knownChildren) {
            //    //if (controller_id == "controller_state") continue;
            //    $controllers.children('#' + controller_id).remove();
            //}
        }

        var $controllers = null;

        var ControllerActive = false;
        var ControllerActiveSubtype = null;
        var ControllerPollAjax = null;

        const cord_formatter = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
            signDisplay: "always"
        });

        $(document).ready(function () {
            $controllers = $('#controllers');
            var $state_data = $('#state_data');

            $controllers.on('click', '.activate_controller', function (evt) {
                evt.preventDefault();
                $state_data.empty();
                //$('#controller_state').remove();
                if (ControllerActive) {
                    //$.post("/activate_controller", null, function (data) { });
                    socket.send(JSON.stringify({ function: 'DeviceManager::ActivateController', data: data }));

                    if (ControllerPollAjax != null) ControllerPollAjax.abort();
                    ControllerActive = false;
                    $controllers.find('.card.border-primary').removeClass('border-primary');
                    $('body').removeClass('controller-active');
                } else {
                    $(evt.target).parent().addClass('border-primary');
                    //$(evt.target).parent().parent().after('<div id="controller_state" class="col-sm-6 col-lg-4 pb-4"/><div class="card"><div class="card-body">TEST</div></div></div>');

                    socket.send(JSON.stringify({ function: 'DeviceManager::ActivateController', data: $(evt.target).data('id') }));
                    /*$.post("/activate_controller", $(evt.target).data('id'), function (data) {
                        if (data) {
                            ControllerActive = true;
                            $('body').addClass('controller-active');
                            PollControllerFunc();
                        } else {
                            //$('#controller_state').remove();
                        }
                    });*/
                }
                return true;
            });

            $controllers.on('click', '.alternate_controller', function (evt) {
                evt.preventDefault();
                var controllerID = $(evt.currentTarget).parents('.controller').find('.activate_controller').data('id');
                var alternateID = $(evt.target).data('id');
                socket.send(JSON.stringify({ function: 'DeviceManager::AlternateController', data: { controller: controllerID, alternate: alternateID } }));
                return true;
            });


            function PollOtherFunc() {/*
                                                                        $.get("/poll_other", function (data) {
                                                                            var knownChildren = {};
                                                                            $controllers.children().each((i, elem) => knownChildren[elem.id] = true);
                                                                            for (const controller_id in data.Controllers) {
                                                                                var controller = data.Controllers[controller_id];

                                                                                var ConnectionIcon = null;
                                                                                for (var idx in controller.ConnectionTypeCode) {
                                                                                    var code = controller.ConnectionTypeCode[idx];
                                                                                    if (data.IconImages[code] != null) {
                                                                                        ConnectionIcon = data.IconImages[code];
                                                                                        break;
                                                                                    }
                                                                                }

                                                                                var ControllerIcon = null;
                                                                                var ControllerImage = null;
                                                                                for (var idx in controller.ControllerTypeCode) {
                                                                                    var code = controller.ControllerTypeCode[idx];
                                                                                    if (ControllerIcon == null && data.IconImages[code] != null) {
                                                                                        ControllerIcon = data.IconImages[code];
                                                                                    }
                                                                                    if (ControllerImage == null && data.ControllerImages[code] != null) {
                                                                                        ControllerImage = data.ControllerImages[code];
                                                                                    }
                                                                                    if (ControllerIcon != null && ControllerImage != null)
                                                                                        break;
                                                                                }

                                                                                var existing = $controllers.children('#controller_' + controller_id);
                                                                                if (existing.length == 0) {
                                                                                    //var wrapper = $('<div class="controller col-md-6 col-lg-4 pb-4"/>');
                                                                                    var wrapper = $('<div class="controller col-12 pb-4"/>');
                                                                                    wrapper.attr('id', 'controller_' + controller_id);
                                                                                    var cardWrapper = $('<div class="card" />');
                                                                                    if (ControllerImage != null) {
                                                                                        var cardImage = $('<img class="controller_image" />');
                                                                                        cardImage.attr("src", "/images/controller/" + ControllerImage);
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                        cardWrapper.append(cardImage);
                                                                                    } else {
                                                                                        var cardImage = $('<img class="controller_image" />');
                                                                                        cardImage.attr("src", "/images/controller/placeholder.png");
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                        cardWrapper.append(cardImage);
                                                                                    }

                                                                                    cardWrapper.append('<div class="card-body"><h5 class="card-title"><img class="connection_icon" /><img class="controller_icon" /><span class="controller_name"></span></h5><p class="card-text controller_name_details" style="white-space:pre;"></p><p class="card-text controller_connection_unique_id"></p><p class="card-text controller_device_unique_id"></p></div>');

                                                                                    if (ControllerIcon != null) {
                                                                                        var cardImage = cardWrapper.find('.controller_icon');
                                                                                        cardImage.attr("src", "/images/icon/" + ControllerIcon);
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                    } else {
                                                                                        var cardImage = cardWrapper.find('.controller_icon');
                                                                                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                    }
                                                                                    if (ConnectionIcon != null) {
                                                                                        var cardImage = cardWrapper.find('.connection_icon');
                                                                                        cardImage.attr("src", "/images/icon/" + ConnectionIcon);
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                    } else {
                                                                                        var cardImage = cardWrapper.find('.connection_icon');
                                                                                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                    }

                                                                                    var menu = $('<div class="list-group small alternate_controller_list" />');
                                                                                    menu.append('<h6 class="list-group-item">Alternate Controllers</h6>');

                                                                                    //if (controller.HasSelectableAlternatives) {
                                                                                    {
                                                                                        for (var alternate in controller.Alternates) {
                                                                                            var alternate_item = $('<a class="alternate_controller list-group-item list-group-item-action" href="#" />');
                                                                                            alternate_item.attr('data-id', alternate);
                                                                                            alternate_item.text(controller.Alternates[alternate]);
                                                                                            menu.append(alternate_item);
                                                                                        }
                                                                                        var alternateBody = $('<div class="card-body" />');
                                                                                        alternateBody.append(menu);
                                                                                        cardWrapper.append(alternateBody);

                                                                                        if (controller.HasSelectableAlternatives) {
                                                                                            alternateBody.show();
                                                                                        } else {
                                                                                            alternateBody.hide();
                                                                                        }
                                                                                    }

                                                                                    cardWrapper.append('<a href="#" class="btn btn-primary btn-lg btn-block activate_controller" role="button" data-id="' + controller_id + '"></a>');
                                                                                    wrapper.append(cardWrapper);
                                                                                } else {
                                                                                    wrapper = existing;
                                                                                    delete knownChildren['controller_' + controller_id];

                                                                                    var menu = wrapper.find('.alternate_controller_list');
                                                                                    if (controller.HasSelectableAlternatives) {
                                                                                        menu.parent().show();
                                                                                    } else {
                                                                                        menu.parent().hide();
                                                                                    }
                                                                                    for (var alternate in controller.Alternates) {
                                                                                        if (menu.children('.alternate_controller[data-id="' + alternate + '"]').length == 0) {
                                                                                            var alternate_item = $('<a class="alternate_controller list-group-item list-group-item-action" href="#" />');
                                                                                            alternate_item.attr('data-id', alternate);
                                                                                            alternate_item.text(controller.Alternates[alternate]);
                                                                                            menu.append(alternate_item);
                                                                                        }
                                                                                    }

                                                                                    if (ControllerImage != null) {
                                                                                        var cardImage = wrapper.find('.controller_image');
                                                                                        cardImage.attr("src", "/images/controller/" + ControllerImage);
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                    } else {
                                                                                        var cardImage = wrapper.find('.controller_image');
                                                                                        cardImage.attr("src", "/images/controller/placeholder.png");
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                    }

                                                                                    if (ControllerIcon != null) {
                                                                                        var cardImage = wrapper.find('.controller_icon');
                                                                                        cardImage.attr("src", "/images/icon/" + ControllerIcon);
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                    } else {
                                                                                        var cardImage = wrapper.find('.controller_icon');
                                                                                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                    }
                                                                                    if (ConnectionIcon != null) {
                                                                                        var cardImage = wrapper.find('.connection_icon');
                                                                                        cardImage.attr("src", "/images/icon/" + ConnectionIcon);
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                    } else {
                                                                                        var cardImage = wrapper.find('.connection_icon');
                                                                                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                                                                                        cardImage.attr("alt", controller.Name);
                                                                                    }
                                                                                }

                                                                                var knownAlternates = {};
                                                                                var alternate_controller_list_dom = wrapper.find('.alternate_controller_list');
                                                                                alternate_controller_list_dom.children('.alternate_controller').each((i, elem) => knownAlternates[$(elem).data('id')] = true);
                                                                                for (const alternate in knownAlternates) {
                                                                                    if (!controller.Alternates[alternate])
                                                                                        alternate_controller_list_dom.children('.alternate_controller[data-id="' + alternate + '"]').remove();
                                                                                }


                                                                                wrapper.find('.controller_name').text(controller.Name);
                                                                                if (controller.NameDetails != null) {
                                                                                    wrapper.find('.controller_name_details').text(controller.NameDetails.join('\r\n'));
                                                                                } else {
                                                                                    wrapper.find('.controller_name_details').text('');
                                                                                }
                                                                                if (controller.ConnectionUniqueID != null) {
                                                                                    wrapper.find('.controller_connection_unique_id').text("Connection:\r\n" + controller.ConnectionUniqueID);
                                                                                } else {
                                                                                    wrapper.find('.controller_connection_unique_id').text('');
                                                                                }
                                                                                if (controller.DeviceUniqueID != null) {
                                                                                    wrapper.find('.controller_device_unique_id').text("Device:\r\n" + controller.DeviceUniqueID);
                                                                                } else {
                                                                                    wrapper.find('.controller_device_unique_id').text('');
                                                                                }

                                                                                if (existing.length == 0) {
                                                                                    $controllers.append(wrapper);
                                                                                }
                                                                            }
                                                                            for (const controller_id in knownChildren) {
                                                                                //if (controller_id == "controller_state") continue;
                                                                                $controllers.children('#' + controller_id).remove();
                                                                            }
                                                                            var existing_manual = {};
                                                                            $('#manual').children().each(function (idx, elem) { existing_manual[$(elem).data('id')] = elem; });
                                                                            for (const device_id in data.ManualDevices) {
                                                                                var manualDevice = data.ManualDevices[device_id];
                                                                                if (existing_manual["60BA"] != null) {
                                                                                    delete existing_manual["60BA"];
                                                                                } else {
                                                                                    var elem = $('<a href="#" class="list-group-item list-group-item-action" />');
                                                                                    elem.attr('data-id', device_id);
                                                                                    elem.text(manualDevice);
                                                                                    $('#manual').append(elem);
                                                                                }
                                                                            }
                                                                            for (var manual_elem_key in existing_manual) {
                                                                                $(existing_manual[manual_elem_key]).remove();
                                                                            }
                                                                        }).done(setTimeout(function () { PollOtherFunc() }, 1000));
                                                                    */}
            $('#manual').on('click', function (evt) {
                evt.preventDefault();

                var IsChildItem = $(evt.target).data('id2') != null;

                var childItems = $('#manual>[data-id="' + $(evt.target).data('id') + '"]>.badge');
                if (childItems.length > 0 && !IsChildItem) {
                    childItems.remove();
                } else {
                    $.post("/manual_device", JSON.stringify({
                        "Code": $(evt.target).data('id'),
                        "Data": IsChildItem ? { "Tag": $(evt.target).data('id2') } : null
                    }), function (data) {
                        if (data) {
                            $('#manual>[data-id="' + data.Code + '"]>.badge').remove();
                            if (data.Data != null && data.Data.Options != null) {
                                for (var option in data.Data.Options) {
                                    var elem = $('<a href="#" class="badge badge-secondary" />');
                                    elem.attr('data-id', data.Code);
                                    elem.attr('data-id2', data.Data.Options[option].Tag);
                                    elem.text(data.Data.Options[option].Name);
                                    $('#manual>[data-id="' + data.Code + '"]').append(elem);
                                }
                            }
                        } else {
                        }
                    });
                }

                return true;
            });

            $('#state_data').on('click', '.control_state_list a.list-group-item', function (evt) {
                evt.preventDefault();
                socket.send(JSON.stringify({ function: 'DeviceManager::SetControlProperty', data: { "controller": $(evt.target).parents('.control_state').data('controller'), "control": $(evt.target).parents('.control_state').data('control-id'), "property": "State", "value": $(evt.target).data('id') } }));
                return true;
            });

            $('#state_data').on('click change', '.control_property_item', function (evt) {
                evt.preventDefault();
                socket.send(JSON.stringify({
                    function: 'DeviceManager::SetControlProperty', data: {
                        "controller": $(evt.target).parents('.control_state').data('controller'),
                        "control": $(evt.target).parents('.control_state').data('control-id'),
                        "property": $(evt.target).data('property'),
                        "value": $(evt.target).val() || $(evt.target).data('value')
                    }
                }));
                return true;
            });

            //PollOtherFunc();
            /*$.get("/startup_data", function (data) {

                ControllerImages = data.ControllerImages;
                IconImages = data.IconImages;

                // manual controller types
                var existing_manual = {};
                $('#manual').children().each(function (idx, elem) { existing_manual[$(elem).data('id')] = elem; });
                for (const device_id in data.ManualDevices) {
                    var manualDevice = data.ManualDevices[device_id];
                    if (existing_manual[device_id] != null) {
                        delete existing_manual[device_id];
                    } else {
                        var elem = $('<a href="#" class="list-group-item list-group-item-action" />');
                        elem.attr('data-id', device_id);
                        elem.text(manualDevice);
                        $('#manual').append(elem);
                    }
                }
                for (var manual_elem_key in existing_manual) {
                    $(existing_manual[manual_elem_key]).remove();
                }
            }).done(SocketStartup);*/
            SocketStartup();
        });
    </script>
</body>
</html>