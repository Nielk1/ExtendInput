<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <style>
        svg .active {
            fill: #333;
        }

        svg .disable {
            fill: red;
        }

        svg .active-o {
            stroke: #333;
        }

        svg .disable-o {
            stroke: red;
        }

        .controller_icon,
        .connection_icon {
            width: auto;
            height: 32px;
            padding-right: 5px;
        }

        #controllers {
            overflow: hidden;
        }
        #controllers_wrapper {
            float: left;
            width: 400px;
            height: 100vh;
            overflow-y: scroll;
            position: fixed;
        }

        #state_data {
            padding-left: 400px;
            margin-left: 5px;
            margin-right: 5px;
        }
        .activate_controller::after {
            content: "Activate";
        }
        .controller-active .activate_controller::after {
            content: "Deactivate";
        }

        .chord_text {
            font-size: 0.6em;
            font-family: monospace;
        }

        .controller_image {
            padding: 5px;
        }

        div.model {
            height: 150px;
        }
    </style>

    <title>Hello, world!</title>
</head>
<body>
    <div class="fluid-container">
        <div class="" id="controllers_wrapper">
            <div class=" col-12 pb-4">
                <div class="list-group" id="manual"></div>
            </div>
            <div class="" id="controllers"></div>
        </div>
        <div class="row" id="state_data"></div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>

    <script src="3d/three.min.js"></script>
    <script src="3d/OrbitControls.js"></script>
    <script src="3d/ColladaLoader.js"></script>

    <script>
        var socket = null;

        var ControllerImages = {};
        var IconImages = {};

        const cyrb53 = function (str, seed = 0) {
            let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
            for (let i = 0, ch; i < str.length; i++) {
                ch = str.charCodeAt(i);
                h1 = Math.imul(h1 ^ ch, 2654435761);
                h2 = Math.imul(h2 ^ ch, 1597334677);
            }
            h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507) ^ Math.imul(h2 ^ (h2 >>> 13), 3266489909);
            h2 = Math.imul(h2 ^ (h2 >>> 16), 2246822507) ^ Math.imul(h1 ^ (h1 >>> 13), 3266489909);
            return 4294967296 * (2097151 & h2) + (h1 >>> 0);
        };

        function SocketStartup() {
            socket = new WebSocket("ws://" + location.host + "/socket");
            //socket.addEventListener('open', function (event) {
            //    socket.send('Hello Server!');
            //});

            // Listen for messages
            socket.addEventListener('message', function (event) {
                var eventData = JSON.parse(event.data)
                switch (eventData.function) {
                    case "DeviceManager:ControllerAdded":
                        console.log("DeviceManager:ControllerAdded ", eventData.data);
                        AddController(eventData.data);
                        break;
                    case "DeviceManager:ControllerRemoved":
                        console.log("DeviceManager:ControllerRemoved ", eventData.data);
                        RemoveController(eventData.data);
                        break;
                    case "DeviceManager:ControllerState":
                        console.log("DeviceManager:ControllerState ", eventData.data);
                        
                        break;
                    default:
                        console.log('Unknown message from server ', eventData);
                        break;
                }
            });

            //socket.onopen = function (event) {
            //    socket.send("Here's some text that the server is urgently awaiting!");
            //    //exampleSocket.send(JSON.stringify({ test: true }));
            //};
        }

        function RemoveController(controller) {
            var controller_id = cyrb53(controller);
            var existing = $controllers.children('#controller_' + controller_id);
            existing.remove();
            // deactivate the controller if it's active
        }

        function AddController(controller) {
            var knownChildren = {};
            $controllers.children().each((i, elem) => knownChildren[elem.id] = true);
            //for (const controller_id in data.Controllers)
            {
                //var controller = data.Controllers[controller_id];

                var controller_id = cyrb53(controller.ConnectionUniqueID);

                var ConnectionIcon = null;
                for (var idx in controller.ConnectionTypeCode) {
                    var code = controller.ConnectionTypeCode[idx];
                    if (IconImages[code] != null) {
                        ConnectionIcon = IconImages[code];
                        break;
                    }
                }

                var ControllerIcon = null;
                var ControllerImage = null;
                for (var idx in controller.ControllerTypeCode) {
                    var code = controller.ControllerTypeCode[idx];
                    if (ControllerIcon == null && IconImages[code] != null) {
                        ControllerIcon = IconImages[code];
                    }
                    if (ControllerImage == null && ControllerImages[code] != null) {
                        ControllerImage = ControllerImages[code];
                    }
                    if (ControllerIcon != null && ControllerImage != null)
                        break;
                }

                var existing = $controllers.children('#controller_' + controller_id);
                if (existing.length == 0) {
                    //var wrapper = $('<div class="controller col-md-6 col-lg-4 pb-4"/>');
                    var wrapper = $('<div class="controller col-12 pb-4"/>');
                    wrapper.attr('id', 'controller_' + controller_id);
                    var cardWrapper = $('<div class="card" />');
                    if (ControllerImage != null) {
                        var cardImage = $('<img class="controller_image" />');
                        cardImage.attr("src", "/images/controller/" + ControllerImage);
                        cardImage.attr("alt", controller.Name);
                        cardWrapper.append(cardImage);
                    } else {
                        var cardImage = $('<img class="controller_image" />');
                        cardImage.attr("src", "/images/controller/placeholder.png");
                        cardImage.attr("alt", controller.Name);
                        cardWrapper.append(cardImage);
                    }

                    cardWrapper.append('<div class="card-body"><h5 class="card-title"><img class="connection_icon" /><img class="controller_icon" /><span class="controller_name"></span></h5><p class="card-text controller_name_details" style="white-space:pre;"></p><p class="card-text controller_connection_unique_id"></p><p class="card-text controller_device_unique_id"></p></div>');

                    if (ControllerIcon != null) {
                        var cardImage = cardWrapper.find('.controller_icon');
                        cardImage.attr("src", "/images/icon/" + ControllerIcon);
                        cardImage.attr("alt", controller.Name);
                    } else {
                        var cardImage = cardWrapper.find('.controller_icon');
                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                        cardImage.attr("alt", controller.Name);
                    }
                    if (ConnectionIcon != null) {
                        var cardImage = cardWrapper.find('.connection_icon');
                        cardImage.attr("src", "/images/icon/" + ConnectionIcon);
                        cardImage.attr("alt", controller.Name);
                    } else {
                        var cardImage = cardWrapper.find('.connection_icon');
                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                        cardImage.attr("alt", controller.Name);
                    }

                    var menu = $('<div class="list-group small alternate_controller_list" />');
                    menu.append('<h6 class="list-group-item">Alternate Controllers</h6>');

                    //if (controller.HasSelectableAlternatives) {
                    {
                        for (var alternate in controller.Alternates) {
                            var alternate_item = $('<a class="alternate_controller list-group-item list-group-item-action" href="#" />');
                            alternate_item.attr('data-id', alternate);
                            alternate_item.text(controller.Alternates[alternate]);
                            menu.append(alternate_item);
                        }
                        var alternateBody = $('<div class="card-body" />');
                        alternateBody.append(menu);
                        cardWrapper.append(alternateBody);

                        if (controller.HasSelectableAlternatives) {
                            alternateBody.show();
                        } else {
                            alternateBody.hide();
                        }
                    }

                    var controllerActivateButton = $('<a href="#" class="btn btn-primary btn-lg btn-block activate_controller" role="button"></a>');
                    controllerActivateButton.attr('data-id', controller.ConnectionUniqueID);
                    cardWrapper.append(controllerActivateButton);
                    wrapper.append(cardWrapper);
                } else {
                    wrapper = existing;
                    delete knownChildren['controller_' + controller_id];

                    var menu = wrapper.find('.alternate_controller_list');
                    if (controller.HasSelectableAlternatives) {
                        menu.parent().show();
                    } else {
                        menu.parent().hide();
                    }
                    for (var alternate in controller.Alternates) {
                        if (menu.children('.alternate_controller[data-id="' + alternate + '"]').length == 0) {
                            var alternate_item = $('<a class="alternate_controller list-group-item list-group-item-action" href="#" />');
                            alternate_item.attr('data-id', alternate);
                            alternate_item.text(controller.Alternates[alternate]);
                            menu.append(alternate_item);
                        }
                    }

                    if (ControllerImage != null) {
                        var cardImage = wrapper.find('.controller_image');
                        cardImage.attr("src", "/images/controller/" + ControllerImage);
                        cardImage.attr("alt", controller.Name);
                    } else {
                        var cardImage = wrapper.find('.controller_image');
                        cardImage.attr("src", "/images/controller/placeholder.png");
                        cardImage.attr("alt", controller.Name);
                    }

                    if (ControllerIcon != null) {
                        var cardImage = wrapper.find('.controller_icon');
                        cardImage.attr("src", "/images/icon/" + ControllerIcon);
                        cardImage.attr("alt", controller.Name);
                    } else {
                        var cardImage = wrapper.find('.controller_icon');
                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                        cardImage.attr("alt", controller.Name);
                    }
                    if (ConnectionIcon != null) {
                        var cardImage = wrapper.find('.connection_icon');
                        cardImage.attr("src", "/images/icon/" + ConnectionIcon);
                        cardImage.attr("alt", controller.Name);
                    } else {
                        var cardImage = wrapper.find('.connection_icon');
                        cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                        cardImage.attr("alt", controller.Name);
                    }
                }

                var knownAlternates = {};
                var alternate_controller_list_dom = wrapper.find('.alternate_controller_list');
                alternate_controller_list_dom.children('.alternate_controller').each((i, elem) => knownAlternates[$(elem).data('id')] = true);
                for (const alternate in knownAlternates) {
                    if (!controller.Alternates[alternate])
                        alternate_controller_list_dom.children('.alternate_controller[data-id="' + alternate + '"]').remove();
                }


                wrapper.find('.controller_name').text(controller.Name);
                if (controller.NameDetails != null) {
                    wrapper.find('.controller_name_details').text(controller.NameDetails.join('\r\n'));
                } else {
                    wrapper.find('.controller_name_details').text('');
                }
                if (controller.ConnectionUniqueID != null) {
                    wrapper.find('.controller_connection_unique_id').text("Connection:\r\n" + controller.ConnectionUniqueID);
                } else {
                    wrapper.find('.controller_connection_unique_id').text('');
                }
                if (controller.DeviceUniqueID != null) {
                    wrapper.find('.controller_device_unique_id').text("Device:\r\n" + controller.DeviceUniqueID);
                } else {
                    wrapper.find('.controller_device_unique_id').text('');
                }

                if (existing.length == 0) {
                    $controllers.append(wrapper);
                }
            }
            //for (const controller_id in knownChildren) {
            //    //if (controller_id == "controller_state") continue;
            //    $controllers.children('#' + controller_id).remove();
            //}
        }

        var $controllers = null;

        var ControllerActive = false;
        var ControllerActiveSubtype = null;
        var ControllerPollAjax = null;

        const cord_formatter = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
            signDisplay: "always"
        });

        $(document).ready(function () {
            $controllers = $('#controllers');
            var $state_data = $('#state_data');

            $controllers.on('click', '.activate_controller', function (evt) {
                evt.preventDefault();
                $state_data.empty();
                //$('#controller_state').remove();
                if (ControllerActive) {
                    //$.post("/activate_controller", null, function (data) { });
                    socket.send(JSON.stringify({ function: 'DeviceManager::ActivateController', data: data }));

                    if (ControllerPollAjax != null) ControllerPollAjax.abort();
                    ControllerActive = false;
                    $controllers.find('.card.border-primary').removeClass('border-primary');
                    $('body').removeClass('controller-active');
                } else {
                    $(evt.target).parent().addClass('border-primary');
                    //$(evt.target).parent().parent().after('<div id="controller_state" class="col-sm-6 col-lg-4 pb-4"/><div class="card"><div class="card-body">TEST</div></div></div>');

                    socket.send(JSON.stringify({ function: 'DeviceManager::ActivateController', data: $(evt.target).data('id') }));
                    /*$.post("/activate_controller", $(evt.target).data('id'), function (data) {
                        if (data) {
                            ControllerActive = true;
                            $('body').addClass('controller-active');
                            PollControllerFunc();
                        } else {
                            //$('#controller_state').remove();
                        }
                    });*/
                }
                return true;
            });

            $controllers.on('click', '.alternate_controller', function (evt) {
                evt.preventDefault();
                var controllerID = $(evt.currentTarget).parents('.controller').attr('id').split('_')[1];
                var alternateID = $(evt.target).data('id');
                $.post("/alternate_controller", { controller: controllerID, alternate: alternateID }, function (data) {
                    /*if (data) {
                        PollControllerFunc();
                    }*/
                });
                return true;
            });

            function DrawButtonSvg(name, x, y) {
                return '<ellipse class="" ry="29" rx="29" cy="' + y + '" cx="' + x + '" stroke="#000" fill="#fff" />' +
                    '<ellipse class="' + name + '_data" ry="0" rx="0" cy="' + y + '" cx="' + x + '" stroke="#000" fill="#333" />';
            }
            function UpdateButtonSvg(ctrl, name, val) {
                ctrl.find(name).attr('rx', val * 29).attr('ry', val * 29);
            }
            function DrawButton2StageSvg(name, x, y) {
                return '<ellipse class="' + name + '_click" ry="29" rx="29" cy="' + y + '" cx="' + x + '" stroke="#ccc" fill="none" stroke-width="3" />' +
                    '<ellipse class="" ry="25" rx="25" cy="' + y + '" cx="' + x + '" stroke="#000" fill="#fff" />' +
                    '<ellipse class="' + name + '_data" ry="0" rx="0" cy="' + y + '" cx="' + x + '" stroke="#000" fill="#333" />';
            }
            function UpdateButton2StageSvg(ctrl, name, val) {
                ctrl.find(name).attr('rx', val * 25).attr('ry', val * 25);
            }

            function RenderControl(control_id, controlData, controlType, $state_data, NewSubtype, knownChildren, childWidth) {
                var existing = $state_data.children('#state_' + control_id);
                //var control = data.controls[control_id];

                if (existing.length == 0) {
                    //var wrapper = $('<div class="col-sm-6 col-md-4 col-lg-3 pb-4"/>');
                    var wrapper = childWidth ? $('<div class="control_state col-12 pb-4"/>') : $('<div class="control_state col-sm-12 col-md-12 col-lg-6 col-xl-4 pb-4"/>');
                    wrapper.attr('id', 'state_' + control_id);
                    wrapper.attr('data-id', control_id);
                    wrapper.append('<div class="card"><div class="pb-3"><h5 class="card-title text-center">' + control_id.replace('-', ':') + '</h5><div class="control_type card-title text-center small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + controlType + '</div><div class="card-text control-value" style="white-space:pre;"></div></div></div>');
                } else {
                    wrapper = existing;
                    var controlTypeD = wrapper.find('.control_type');
                    if (controlTypeD.text() != controlType)
                        controlTypeD.text(controlType);
                    delete knownChildren['state_' + control_id];
                }

                switch (controlType == null ? controlType : controlType.split('[')[0]) {
                    case 'ExtendInput.Controls.ControlButtonQuad':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                renderElement.empty().append(
                                    '<svg id="control_render_' + control_id + '" width="182" height="182" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g>' +
                                    DrawButtonSvg("btn_n", 91, 31) +
                                    DrawButtonSvg("btn_e", 151, 91) +
                                    DrawButtonSvg("btn_s", 91, 151) +
                                    DrawButtonSvg("btn_w", 31, 91) +
                                    '</g>' +
                                    '</svg>');
                            }
                            var ctrl = $('#control_render_' + control_id);
                            if (controlData.ButtonN) {
                                UpdateButtonSvg(ctrl, '.btn_n_data', 1);
                            } else {
                                UpdateButtonSvg(ctrl, '.btn_n_data', 0);
                            }
                            if (controlData.ButtonE) {
                                UpdateButtonSvg(ctrl, '.btn_e_data', 1);
                            } else {
                                UpdateButtonSvg(ctrl, '.btn_e_data', 0);
                            }
                            if (controlData.ButtonS) {
                                UpdateButtonSvg(ctrl, '.btn_s_data', 1);
                            } else {
                                UpdateButtonSvg(ctrl, '.btn_s_data', 0);
                            }
                            if (controlData.ButtonW) {
                                UpdateButtonSvg(ctrl, '.btn_w_data', 1);
                            } else {
                                UpdateButtonSvg(ctrl, '.btn_w_data', 0);
                            }
                        }
                        break;
                    case 'ExtendInput.Controls.ControlButton':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                renderElement.empty().append(
                                    '<svg id="control_render_' + control_id + '" width="62" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g>' +
                                    DrawButtonSvg("btn_x", 31, 31) +
                                    '</g>' +
                                    '</svg>');
                            }
                            var ctrl = $('#control_render_' + control_id);
                            if (controlData.DigitalStage1) {
                                UpdateButtonSvg(ctrl, '.btn_x_data', 1);
                            } else {
                                UpdateButtonSvg(ctrl, '.btn_x_data', 0);
                            }
                        }
                        break;
                    case 'ExtendInput.Controls.ControlButtonPS5Mute':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                renderElement.empty().append(
                                    '<svg id="control_render_' + control_id + '" width="62" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g>' +
                                    '<ellipse class="" ry="29" rx="29" cy="' + 31 + '" cx="' + 31 + '" stroke="#000" fill="#fff" />' +
                                    '<ellipse class="btn_x_data" ry="0" rx="0" cy="' + 31 + '" cx="' + 31 + '" stroke="#000" fill="#333" />' +
                                    '</g>' +
                                    '</svg>');
                                var listElement = $('<div class="list-group p-1 control_state_list" id="control_state_list_' + control_id + '"/>');
                                renderElement.append(listElement);
                            }
                            var ctrl = $('#control_render_' + control_id);
                            var listElement = $('#control_state_list_' + control_id);
                            if (controlData.States.length != listElement.children().length) {
                                listElement.empty();
                            } else {
                                for (var idx in controlData.States) {
                                    if (listElement.find('a[data-id="' + controlData.States[idx] + '"]').length == 0) {
                                        listElement.empty();
                                        break;
                                    }
                                }
                            }
                            if (controlData.States.length != listElement.children().length) {
                                for (var idx in controlData.States) {
                                    listElement.append('<a href="#" class="list-group-item list-group-item-action' + (controlData.States[idx] == controlData.State ? ' active' : '') + '" data-id="' + controlData.States[idx] + '">' + controlData.States[idx] + '</a>');
                                }
                            } else {
                                listElement.find('[data-id="' + controlData.State + '"]').addClass('active');
                                listElement.find('.active[data-id][data-id!="' + controlData.State + '"]').removeClass('active');
                            }
                            if (controlData.DigitalStage1) {
                                ctrl.find(".btn_x_data").attr('rx', 29).attr('ry', 29);
                            } else {
                                ctrl.find(".btn_x_data").attr('rx', 0).attr('ry', 0);
                            }
                        }
                        break;
                    case 'ExtendInput.Controls.ControlTrigger':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                renderElement.empty().append(
                                    '<svg id="control_render_' + control_id + '" width="62" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g>' +
                                    DrawButtonSvg("btn_x", 31, 31) +
                                    '</g>' +
                                    '</svg>');
                            }
                            var ctrl = $('#control_render_' + control_id);
                            UpdateButtonSvg(ctrl, '.btn_x_data', controlData.AnalogStage1);
                        }
                        break;
                    case 'ExtendInput.Controls.ControlTrigger2Stage':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                renderElement.empty().append(
                                    '<svg id="control_render_' + control_id + '" width="62" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g>' +
                                    DrawButton2StageSvg("btn_x", 31, 31) +
                                    '</g>' +
                                    '</svg>');
                            }
                            var ctrl = $('#control_render_' + control_id);
                            UpdateButton2StageSvg(ctrl, '.btn_x_data', controlData.AnalogStage1);
                            if (controlData.DigitalStage2) ctrl.find('.btn_x_click').addClass('active-o'); else ctrl.find('.btn_x_click').removeClass('active-o');
                        }
                        break;
                    case 'ExtendInput.Controls.ControlDPad':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                renderElement.empty().append(
                                    '<svg id="control_render_' + control_id + '" width="182" height="182" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g>' +
                                    '<path class="btn_n" d="M 091,031 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(180 091 031) translate(-30,-30)"></path>' +
                                    '<path class="btn_e" d="M 151,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(-90 151 091) translate(-30,-30)"></path>' +
                                    '<path class="btn_s" d="M 091,151 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(0 091 151) translate(-30,-30)"></path>' +
                                    '<path class="btn_w" d="M 031,091 m 0,0 30,60 30,-60 z" stroke="#000" fill="#fff" transform="rotate(90 031 091) translate(-30,-30)"></path>' +
                                    '</g>' +
                                    '</svg>');
                            }
                            var ctrl = $('#control_render_' + control_id);
                            switch (controlData.Direction) {
                                case "None":
                                case 0: ctrl.find('.btn_n,.btn_e,.btn_s,.btn_w').removeClass('active'); break;
                                case "North":
                                case 1: ctrl.find('       .btn_e,.btn_s,.btn_w').removeClass('active'); ctrl.find('.btn_n                     ').addClass('active'); break;
                                case "NorthEast":
                                case 2: ctrl.find('              .btn_s,.btn_w').removeClass('active'); ctrl.find('.btn_n,.btn_e              ').addClass('active'); break;
                                case "East":
                                case 3: ctrl.find('.btn_n,       .btn_s,.btn_w').removeClass('active'); ctrl.find('       .btn_e              ').addClass('active'); break;
                                case "SouthEast":
                                case 4: ctrl.find('.btn_n,              .btn_w').removeClass('active'); ctrl.find('       .btn_e,.btn_s       ').addClass('active'); break;
                                case "South":
                                case 5: ctrl.find('.btn_n,.btn_e,       .btn_w').removeClass('active'); ctrl.find('              .btn_s       ').addClass('active'); break;
                                case "SouthWest":
                                case 6: ctrl.find('.btn_n,.btn_e              ').removeClass('active'); ctrl.find('              .btn_s,.btn_w').addClass('active'); break;
                                case "West":
                                case 7: ctrl.find('.btn_n,.btn_e,.btn_s       ').removeClass('active'); ctrl.find('                     .btn_w').addClass('active'); break;
                                case "NorthWest":
                                case 8: ctrl.find('       .btn_e,.btn_s       ').removeClass('active'); ctrl.find('.btn_n,              .btn_w').addClass('active'); break;
                            }
                        }
                        break;
                    case 'ExtendInput.Controls.ControlStick':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                renderElement.empty().append(
                                    '<svg id="control_render_' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g>' +
                                    //'<path class="stick_click" d="M 2,2 m 0,136 136,0 0,-136 -136,0 z" stroke="#999" fill="none" stroke-width="3"></path>' +
                                    '<path class="" d="M 6,6 m 0,128 128,0 0,-128 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                    '<ellipse class="" ry="64" rx="64" cy="70" cx="70" stroke="#000" fill="#fff" />' +
                                    '<g class="stick_float" cy="70" cx="70">' +
                                    '<ellipse ry="2" rx="2" cy="0" cx="0" fill="#000" />' +
                                    '<text class="chord_text stick_float_text" x="-4" y="4" transform="translate(5,-5)"></text>' +
                                    '</g>' +
                                    '</g>' +
                                    '</svg>');
                            }
                            var ctrl = $('#control_render_' + control_id);
                            var stickFloat = ctrl.find('.stick_float');
                            stickFloat.attr('transform', 'translate(' + (70 + controlData.X * 63) + ',' + (70 + controlData.Y * 63) + ')');
                            stickFloat.children('.stick_float_text').attr('transform', 'translate(' + (controlData.X > 0 ? 0 : 6) + ',' + (controlData.Y > 0 ? -6 : 6) + ')').attr('text-anchor', (controlData.X > 0 ? "end" : "initial")).text(cord_formatter.format(controlData.X) + ',' + cord_formatter.format(controlData.Y));
                        }
                        break;
                    case 'ExtendInput.Controls.ControlStickWithClick':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                renderElement.empty().append(
                                    '<svg id="control_render_' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g>' +
                                    '<path class="stick_click" d="M 2,2 m 0,136 136,0 0,-136 -136,0 z" stroke="#999" fill="none" stroke-width="3"></path>' +
                                    '<path class="" d="M 6,6 m 0,128 128,0 0,-128 -128,0 z" stroke="#000" fill="#fff"></path>' +
                                    '<ellipse class="" ry="64" rx="64" cy="70" cx="70" stroke="#000" fill="#fff" />' +
                                    '<g class="stick_float" cy="70" cx="70">' +
                                    '<ellipse ry="2" rx="2" cy="0" cx="0" fill="#000" />' +
                                    '<text class="chord_text stick_float_text" x="-4" y="4" transform="translate(5,-5)"></text>' +
                                    '</g>' +
                                    '</g>' +
                                    '</svg>');
                            }
                            var ctrl = $('#control_render_' + control_id);
                            var stickFloat = ctrl.find('.stick_float');
                            stickFloat.attr('transform', 'translate(' + (70 + controlData.X * 63) + ',' + (70 + controlData.Y * 63) + ')');
                            stickFloat.children('.stick_float_text').attr('transform', 'translate(' + (controlData.X > 0 ? 0 : 6) + ',' + (controlData.Y > 0 ? -6 : 6) + ')').attr('text-anchor', (controlData.X > 0 ? "end" : "initial")).text(cord_formatter.format(controlData.X) + ',' + cord_formatter.format(controlData.Y));
                            if (controlData.Click) ctrl.find('.stick_click').addClass('active-o'); else ctrl.find('.stick_click').removeClass('active-o');
                        }
                        break;
                    case 'ExtendInput.Controls.ControlTouch':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            var ratioW = 1;
                            var ratioH = 1;
                            if (controlData.PhysicalWidth > controlData.PhysicalHeight) {
                                ratioH = controlData.PhysicalHeight / controlData.PhysicalWidth;
                            } else {
                                ratioW = controlData.PhysicalWidth / controlData.PhysicalHeight;
                            }
                            if (!isFinite(ratioW) || !isFinite(ratioH)) {
                                ratioW = 1;
                                ratioH = 1;
                            }
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                var domString =
                                    '<svg id="control_render_' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g transform="translate(' + (((1 - ratioW) / 2) * 130) + ',' + (((1 - ratioH) / 2) * 130) + ')">' +
                                    '<path class="pad_click" d="M 2,2 m 0,' + (128 * ratioH + 8) + ' ' + (128 * ratioW + 8) + ',0 0,-' + (128 * ratioH + 8) + ' -' + (128 * ratioW + 8) + ',0 z" stroke="#999" fill="none" stroke-width="3"></path>' +
                                    '<path class="" d="M 6,6 m 0,' + (128 * ratioH) + ' ' + (128 * ratioW) + ',0 0,-' + (128 * ratioH) + ' -' + (128 * ratioW) + ',0 z" stroke="#000" fill="#fff"></path>';
                                //'<ellipse class="" ry="64" rx="64" cy="70" cx="70" stroke="#000" fill="#fff" />' +
                                for (var i = 0; i < controlData.Touch.length; i++) {
                                    domString +=
                                        '<g cy="70" cx="70" class="pad_float_' + i + '" style="display: none;">' +
                                        '<ellipse ry="2" rx="2" cy="0" cx="0" fill="#000" />' +
                                        '<text class="chord_text pad_float_text" x="-4" y="4" transform="translate(5,-5)">' +
                                        '<tspan x="0", dy="0em">' + i + '</tspan>' +
                                        '<tspan x="0", dy="1em"> 0.00, 0.00</tspan>' +
                                        '</text>' +
                                        '</g>';
                                }
                                domString +=
                                    '</g>' +
                                    '</svg>';
                                renderElement.empty().append(domString);
                            }
                            var ctrl = $('#control_render_' + control_id);
                            for (var i = 0; i < controlData.Touch.length; i++) {
                                var stickFloat = ctrl.find('.pad_float_' + i);
                                if (controlData.Touch[i]) {
                                    stickFloat.attr('transform', 'translate(' + (6 + (64 + controlData.X[i] * 63) * ratioW) + ',' + (6 + (64 + controlData.Y[i] * 63) * ratioH) + ')');
                                    stickFloat.children('.pad_float_text').attr('transform', 'translate(' + (controlData.X[i] > 0 ? -6 : 6) + ',' + (controlData.Y[i] > 0 ? -6 : 6) + ')').attr('text-anchor', (controlData.X[i] > 0 ? "end" : "initial"));
                                    stickFloat.children('.pad_float_text').children('tspan:first()').text(i);
                                    stickFloat.children('.pad_float_text').children('tspan:last()').text(cord_formatter.format(controlData.X[i]) + ',' + cord_formatter.format(controlData.Y[i])).attr("dy", controlData.Y[i] > 0 ? "-1em" : "1em");
                                    stickFloat.show();
                                } else {
                                    stickFloat.hide();
                                }
                            }
                            if (controlData.HasClick) if (controlData.Click) ctrl.find('.pad_click').addClass('active-o'); else ctrl.find('.pad_click').removeClass('active-o', 'disable-o'); else ctrl.find('.pad_click').addClass('disable-o');
                        }
                        break;
                    case 'ExtendInput.Controls.ControlButtonGrid':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                var domString =
                                    '<svg id="control_render_' + control_id + '" width="140" height="140" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g>';
                                for (var x = 0; x < controlData.Button.length; x++) {
                                    for (var y = 0; y < controlData.Button[0].length; y++) {
                                        var sizeX = 136 / controlData.Button.length;
                                        var sizeY = 136 / controlData.Button[0].length;
                                        domString += '<path class="btn_' + x + '_' + y + '" d="M ' + (1 + sizeX * x) + ',' + (1 + sizeY * y) + ' m 0,' + sizeY + ' ' + sizeX + ',0 0,-' + sizeY + ' -' + sizeX + ',0 z" stroke="#999" fill="none" stroke-width="2"></path>';
                                    }
                                }
                                domString +=
                                    '</g>' +
                                    '</svg>'
                                renderElement.empty().append(domString);
                            }
                            var ctrl = $('#control_render_' + control_id);
                            '<g>';
                            for (var x = 0; x < controlData.Button.length; x++) {
                                for (var y = 0; y < controlData.Button[0].length; y++) {
                                    if (controlData.Button[x][y]) ctrl.find('.btn_' + x + '_' + y).addClass('active'); else ctrl.find('.btn_' + x + '_' + y).removeClass('active');
                                }
                            }
                            //var stickFloat = ctrl.find('.stick_float');
                            //stickFloat.attr('cx', 70 + controlData.X * 63);
                            //stickFloat.attr('cy', 70 + controlData.Y * 63);
                            //if (controlData.HasClick) if (controlData.Click) ctrl.find('.stick_click').addClass('active-o'); else ctrl.find('.stick_click').removeClass('active-o', 'disable-o'); else ctrl.find('.stick_click').addClass('disable-o');
                        }
                        break;
                    /*case 'ExtendInput.Controls.ControlButtonPair':
                        //case 'ExtendInput.Controls.ControlTriggerPair':
                        {
                            var renderElement = wrapper.find('.control-value');
                            renderElement.addClass('text-center');
                            if (NewSubtype || renderElement.children('svg').length == 0) {
                                renderElement.empty().append(
                                    '<svg id="control_render_' + control_id + '" width="182" height="62" xmlns="http://www.w3.org/2000/svg">' +
                                    '<g>' +

                                    //'<ellipse class="btn_l_click" ry="29" rx="29" cy="31" cx="031" stroke="#ccc" fill="none" stroke-width="3" />' +
                                    //'<ellipse class="" ry="25" rx="25" cy="31" cx="031" stroke="#000" fill="#fff" />' +
                                    //'<ellipse class="btn_l_data" ry="0" rx="0" cy="31" cx="031" stroke="#000" fill="#333" />' +
                                    DrawButtonSvg("btn_l", 31, 31) +

                                    //'<ellipse class="btn_r_click" ry="29" rx="29" cy="31" cx="151" stroke="#ccc" fill="none" stroke-width="3" />' +
                                    //'<ellipse class="" ry="25" rx="25" cy="31" cx="151" stroke="#000" fill="#fff" />' +
                                    //'<ellipse class="btn_r_data" ry="0" rx="0" cy="31" cx="151" stroke="#000" fill="#333" />' +
                                    DrawButtonSvg("btn_r", 151, 31) +

                                    '</g>' +
                                    '</svg>');
                            }
                            var ctrl = $('#control_render_' + control_id);
                            if (controlData.Left.Button0) {
                                ctrl.find('.btn_l_data').attr('rx', 25).attr('ry', 25);
                            } else {
                                ctrl.find('.btn_l_data').attr('rx', controlData.Left.Analog * 25).attr('ry', controlData.Left.Analog * 25);
                            }
                            if (controlData.Right.Button0) {
                                ctrl.find('.btn_r_data').attr('rx', 25).attr('ry', 25);
                            } else {
                                ctrl.find('.btn_r_data').attr('rx', controlData.Right.Analog * 25).attr('ry', controlData.Right.Analog * 25);
                            }
                            if (controlData.Left.HasStage2 == "Digital") if (controlData.Left.Stage2) ctrl.find('.btn_l_click').addClass('active-o'); else ctrl.find('.btn_l_click').removeClass('active-o', 'disable-o'); else ctrl.find('.btn_l_click').addClass('disable-o');
                            if (controlData.Right.HasStage2 == "Digital") if (controlData.Right.Stage2) ctrl.find('.btn_r_click').addClass('active-o'); else ctrl.find('.btn_r_click').removeClass('active-o', 'disable-o'); else ctrl.find('.btn_r_click').addClass('disable-o');
                        }
                        break;
                    case 'ExtendInput.Controls.ControlPair':
                        {
                            var renderElement = wrapper.find('.control-value');
                            //renderElement.addClass('text-center');
                            var ctrl = $('#control_render_' + control_id);
                            if (controlData.Button0) ctrl.find('.btn_x').addClass('active'); else ctrl.find('.btn_x').removeClass('active');

                            RenderControl(control_id + "-Left", controlData.Left, controlType.split('[')[1].split(']')[0], renderElement, NewSubtype, knownChildren, true);
                            RenderControl(control_id + "-Right", controlData.Right, controlType.split('[')[1].split(']')[0], renderElement, NewSubtype, knownChildren, true);

                            //RenderControl(control_id + "-Left", controlData.Left, controlType.split('[')[1].split(']')[0], $state_data, NewSubtype, knownChildren);
                            //RenderControl(control_id + "-Right", controlData.Right, controlType.split('[')[1].split(']')[0], $state_data, NewSubtype, knownChildren);
                        }
                        break;*/
                    case 'ExtendInput.Controls.ControlMotion':
                        {
                            var renderElement = wrapper.find('.control-value');
                            if (NewSubtype || renderElement.children('div.model').length == 0) {
                                renderElement.empty().append('<div class="model"/>');
                                var container = renderElement.children('div.model')[0];
                                var renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                                renderer.setSize(container.clientWidth, container.clientHeight);
                                container.innerHTML = '';
                                container.appendChild(renderer.domElement);
                                renderer.setClearColor(0xFFFFFF, 0);
                                renderer.clear();
                                window.camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
                                //camera.position.x = -1; camera.position.y = 1; camera.position.z = -1;
                                camera.position.z = 1;
                                /*var cameraControls;
                                cameraControls = new THREE.OrbitControls(camera, renderer.domElement);
                                cameraControls.target.set(0, 0, 0);
                                cameraControls.maxDistance = 0.5;
                                cameraControls.minDistance = 0.3;
                                cameraControls.update();*/

                                var scene = new THREE.Scene();

                                var ambientLight = new THREE.AmbientLight(0x888888);
                                scene.add(ambientLight);

                                var light = new THREE.SpotLight();
                                light.castShadow = true;
                                light.position.set(170, 330, -160);
                                scene.add(light);

                                var loader = new THREE.ColladaLoader();
                                loader.load("./3d/model.dae", function (geometry, materials) {
                                    //geometry.scene = geometry.scene.translateZ(-0.5);
                                    scene.add(geometry.scene);
                                    model_bz1 = geometry.scene;
                                    model_bz1.visible = true;
                                });

                                scene.add(camera);
                                pointLight = new THREE.PointLight(0x888888);
                                pointLight.position.set(1, 1, 2);
                                camera.add(pointLight);

                                renderer.render(scene, camera);

                                $(container).data('render', renderer);

                                setTimeout(onWindowResize, 100);

                                function update() {
                                    requestAnimationFrame(update);
                                    //cameraControls.update();
                                    renderer.render(scene, camera);
                                }

                                update();
                            }
                        }
                        break;
                    default:
                        wrapper.find('.control-value').addClass('text-monospace small').text(JSON.stringify(controlData, null, 2));
                        break;
                }

                if (existing.length == 0) {
                    $state_data.append(wrapper);
                }
            }

            function onWindowResize(event) {
                $('div.model').each(function (idx, elem) {

                    SCREEN_WIDTH = elem.clientWidth;
                    SCREEN_HEIGHT = elem.clientHeight;

                    var renderer = $(elem).data('render');

                    renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);

                    camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
                    camera.updateProjectionMatrix();
                });
            }

            window.addEventListener('resize', onWindowResize, false);

            function PollControllerFunc() {
                if (ControllerPollAjax != null) ControllerPollAjax.abort();
                if (ControllerActive) {
                    ControllerPollAjax = $.get("/poll_controller", function (data) {
                        var knownChildren = {};
                        $state_data.children().each((i, elem) => knownChildren[elem.id] = true);
                        var NewSubtype = (ControllerActiveSubtype != data.subtype);
                        ControllerActiveSubtype = data.subtype;
                        for (const control_id in data.controls) {
                            RenderControl(control_id, data.controls[control_id].Data, data.controls[control_id].Type, $state_data, NewSubtype, knownChildren);
                        }
                        for (const control_id in knownChildren) {
                            $state_data.children('#' + control_id).remove();
                        }
                    }).done(function () {
                        if (ControllerActive)
                            PollControllerFunc();
                    });
                }
            }

            function PollOtherFunc() {/*
                    $.get("/poll_other", function (data) {
                        var knownChildren = {};
                        $controllers.children().each((i, elem) => knownChildren[elem.id] = true);
                        for (const controller_id in data.Controllers) {
                            var controller = data.Controllers[controller_id];

                            var ConnectionIcon = null;
                            for (var idx in controller.ConnectionTypeCode) {
                                var code = controller.ConnectionTypeCode[idx];
                                if (data.IconImages[code] != null) {
                                    ConnectionIcon = data.IconImages[code];
                                    break;
                                }
                            }

                            var ControllerIcon = null;
                            var ControllerImage = null;
                            for (var idx in controller.ControllerTypeCode) {
                                var code = controller.ControllerTypeCode[idx];
                                if (ControllerIcon == null && data.IconImages[code] != null) {
                                    ControllerIcon = data.IconImages[code];
                                }
                                if (ControllerImage == null && data.ControllerImages[code] != null) {
                                    ControllerImage = data.ControllerImages[code];
                                }
                                if (ControllerIcon != null && ControllerImage != null)
                                    break;
                            }

                            var existing = $controllers.children('#controller_' + controller_id);
                            if (existing.length == 0) {
                                //var wrapper = $('<div class="controller col-md-6 col-lg-4 pb-4"/>');
                                var wrapper = $('<div class="controller col-12 pb-4"/>');
                                wrapper.attr('id', 'controller_' + controller_id);
                                var cardWrapper = $('<div class="card" />');
                                if (ControllerImage != null) {
                                    var cardImage = $('<img class="controller_image" />');
                                    cardImage.attr("src", "/images/controller/" + ControllerImage);
                                    cardImage.attr("alt", controller.Name);
                                    cardWrapper.append(cardImage);
                                } else {
                                    var cardImage = $('<img class="controller_image" />');
                                    cardImage.attr("src", "/images/controller/placeholder.png");
                                    cardImage.attr("alt", controller.Name);
                                    cardWrapper.append(cardImage);
                                }

                                cardWrapper.append('<div class="card-body"><h5 class="card-title"><img class="connection_icon" /><img class="controller_icon" /><span class="controller_name"></span></h5><p class="card-text controller_name_details" style="white-space:pre;"></p><p class="card-text controller_connection_unique_id"></p><p class="card-text controller_device_unique_id"></p></div>');

                                if (ControllerIcon != null) {
                                    var cardImage = cardWrapper.find('.controller_icon');
                                    cardImage.attr("src", "/images/icon/" + ControllerIcon);
                                    cardImage.attr("alt", controller.Name);
                                } else {
                                    var cardImage = cardWrapper.find('.controller_icon');
                                    cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                                    cardImage.attr("alt", controller.Name);
                                }
                                if (ConnectionIcon != null) {
                                    var cardImage = cardWrapper.find('.connection_icon');
                                    cardImage.attr("src", "/images/icon/" + ConnectionIcon);
                                    cardImage.attr("alt", controller.Name);
                                } else {
                                    var cardImage = cardWrapper.find('.connection_icon');
                                    cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                                    cardImage.attr("alt", controller.Name);
                                }

                                var menu = $('<div class="list-group small alternate_controller_list" />');
                                menu.append('<h6 class="list-group-item">Alternate Controllers</h6>');

                                //if (controller.HasSelectableAlternatives) {
                                {
                                    for (var alternate in controller.Alternates) {
                                        var alternate_item = $('<a class="alternate_controller list-group-item list-group-item-action" href="#" />');
                                        alternate_item.attr('data-id', alternate);
                                        alternate_item.text(controller.Alternates[alternate]);
                                        menu.append(alternate_item);
                                    }
                                    var alternateBody = $('<div class="card-body" />');
                                    alternateBody.append(menu);
                                    cardWrapper.append(alternateBody);

                                    if (controller.HasSelectableAlternatives) {
                                        alternateBody.show();
                                    } else {
                                        alternateBody.hide();
                                    }
                                }

                                cardWrapper.append('<a href="#" class="btn btn-primary btn-lg btn-block activate_controller" role="button" data-id="' + controller_id + '"></a>');
                                wrapper.append(cardWrapper);
                            } else {
                                wrapper = existing;
                                delete knownChildren['controller_' + controller_id];

                                var menu = wrapper.find('.alternate_controller_list');
                                if (controller.HasSelectableAlternatives) {
                                    menu.parent().show();
                                } else {
                                    menu.parent().hide();
                                }
                                for (var alternate in controller.Alternates) {
                                    if (menu.children('.alternate_controller[data-id="' + alternate + '"]').length == 0) {
                                        var alternate_item = $('<a class="alternate_controller list-group-item list-group-item-action" href="#" />');
                                        alternate_item.attr('data-id', alternate);
                                        alternate_item.text(controller.Alternates[alternate]);
                                        menu.append(alternate_item);
                                    }
                                }

                                if (ControllerImage != null) {
                                    var cardImage = wrapper.find('.controller_image');
                                    cardImage.attr("src", "/images/controller/" + ControllerImage);
                                    cardImage.attr("alt", controller.Name);
                                } else {
                                    var cardImage = wrapper.find('.controller_image');
                                    cardImage.attr("src", "/images/controller/placeholder.png");
                                    cardImage.attr("alt", controller.Name);
                                }

                                if (ControllerIcon != null) {
                                    var cardImage = wrapper.find('.controller_icon');
                                    cardImage.attr("src", "/images/icon/" + ControllerIcon);
                                    cardImage.attr("alt", controller.Name);
                                } else {
                                    var cardImage = wrapper.find('.controller_icon');
                                    cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                                    cardImage.attr("alt", controller.Name);
                                }
                                if (ConnectionIcon != null) {
                                    var cardImage = wrapper.find('.connection_icon');
                                    cardImage.attr("src", "/images/icon/" + ConnectionIcon);
                                    cardImage.attr("alt", controller.Name);
                                } else {
                                    var cardImage = wrapper.find('.connection_icon');
                                    cardImage.attr("src", "/images/icon/DEVICE_UNKNOWN.png");
                                    cardImage.attr("alt", controller.Name);
                                }
                            }

                            var knownAlternates = {};
                            var alternate_controller_list_dom = wrapper.find('.alternate_controller_list');
                            alternate_controller_list_dom.children('.alternate_controller').each((i, elem) => knownAlternates[$(elem).data('id')] = true);
                            for (const alternate in knownAlternates) {
                                if (!controller.Alternates[alternate])
                                    alternate_controller_list_dom.children('.alternate_controller[data-id="' + alternate + '"]').remove();
                            }


                            wrapper.find('.controller_name').text(controller.Name);
                            if (controller.NameDetails != null) {
                                wrapper.find('.controller_name_details').text(controller.NameDetails.join('\r\n'));
                            } else {
                                wrapper.find('.controller_name_details').text('');
                            }
                            if (controller.ConnectionUniqueID != null) {
                                wrapper.find('.controller_connection_unique_id').text("Connection:\r\n" + controller.ConnectionUniqueID);
                            } else {
                                wrapper.find('.controller_connection_unique_id').text('');
                            }
                            if (controller.DeviceUniqueID != null) {
                                wrapper.find('.controller_device_unique_id').text("Device:\r\n" + controller.DeviceUniqueID);
                            } else {
                                wrapper.find('.controller_device_unique_id').text('');
                            }

                            if (existing.length == 0) {
                                $controllers.append(wrapper);
                            }
                        }
                        for (const controller_id in knownChildren) {
                            //if (controller_id == "controller_state") continue;
                            $controllers.children('#' + controller_id).remove();
                        }
                        var existing_manual = {};
                        $('#manual').children().each(function (idx, elem) { existing_manual[$(elem).data('id')] = elem; });
                        for (const device_id in data.ManualDevices) {
                            var manualDevice = data.ManualDevices[device_id];
                            if (existing_manual["60BA"] != null) {
                                delete existing_manual["60BA"];
                            } else {
                                var elem = $('<a href="#" class="list-group-item list-group-item-action" />');
                                elem.attr('data-id', device_id);
                                elem.text(manualDevice);
                                $('#manual').append(elem);
                            }
                        }
                        for (var manual_elem_key in existing_manual) {
                            $(existing_manual[manual_elem_key]).remove();
                        }
                    }).done(setTimeout(function () { PollOtherFunc() }, 1000));
                */}
            $('#manual').on('click', function (evt) {
                evt.preventDefault();

                var IsChildItem = $(evt.target).data('id2') != null;

                var childItems = $('#manual>[data-id="' + $(evt.target).data('id') + '"]>.badge');
                if (childItems.length > 0 && !IsChildItem) {
                    childItems.remove();
                } else {
                    $.post("/manual_device", JSON.stringify({
                        "Code": $(evt.target).data('id'),
                        "Data": IsChildItem ? { "Tag": $(evt.target).data('id2') } : null
                    }), function (data) {
                        if (data) {
                            $('#manual>[data-id="' + data.Code + '"]>.badge').remove();
                            if (data.Data != null && data.Data.Options != null) {
                                for (var option in data.Data.Options) {
                                    var elem = $('<a href="#" class="badge badge-secondary" />');
                                    elem.attr('data-id', data.Code);
                                    elem.attr('data-id2', data.Data.Options[option].Tag);
                                    elem.text(data.Data.Options[option].Name);
                                    $('#manual>[data-id="' + data.Code + '"]').append(elem);
                                }
                            }
                        } else {
                        }
                    });
                }

                return true;
            });

            $('#state_data').on('click', '.control_state_list a.list-group-item', function (evt) {
                evt.preventDefault();
                $.post("/activate_control_mode", { "id": $(evt.target).parents('.control_state').data('id'), "state": $(evt.target).data('id') }, function (data) {
                    if (data) {
                    } else {
                        //$('#controller_state').remove();
                    }
                });

                return true;
            });

            //PollOtherFunc();
            $.get("/startup_data", function (data) {

                ControllerImages = data.ControllerImages;
                IconImages = data.IconImages;

                // manual controller types
                var existing_manual = {};
                $('#manual').children().each(function (idx, elem) { existing_manual[$(elem).data('id')] = elem; });
                for (const device_id in data.ManualDevices) {
                    var manualDevice = data.ManualDevices[device_id];
                    if (existing_manual[device_id] != null) {
                        delete existing_manual[device_id];
                    } else {
                        var elem = $('<a href="#" class="list-group-item list-group-item-action" />');
                        elem.attr('data-id', device_id);
                        elem.text(manualDevice);
                        $('#manual').append(elem);
                    }
                }
                for (var manual_elem_key in existing_manual) {
                    $(existing_manual[manual_elem_key]).remove();
                }
            }).done(SocketStartup);
        });
    </script>
</body>
</html>